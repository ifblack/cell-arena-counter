
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Cell Arena ATP Counter (Dynamic Players v3.4)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  :root {
    --accent: #1976d2;
    --border: #d8dee9;
    --text: #1f2937;
    --shadow: 0 2px 6px rgba(0,0,0,0.06);
    --on: #2e7d32;
    --off: #b00020;
  }
  * { box-sizing: border-box; }
  body { font-family: "Segoe UI", "PingFang SC", "Microsoft Yahei", sans-serif; margin:0; background:#f8fbff; color:var(--text); }
  h1 { text-align:center; color:#1a2c43; margin:16px 0; }

  .topbar { background:#f0f0f0; padding:10px; text-align:center; }
  .topbar a { margin:0 10px; font-size:14px; color:#333; text-decoration:none; }

  .wrapper { width:100%; display:flex; flex-direction:column; align-items:center; padding:10px; }

  .panel, .player {
    width:400px;
    margin:14px auto;
    background:#fff;
    border:2px solid var(--border);
    border-radius:12px;
    box-shadow:var(--shadow);
    padding:12px;
  }
  #leaderboard { background:#e3f2fd; }

  .lb-head {
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    margin-bottom:6px;
  }
  .lb-title { display:flex; align-items:center; gap:8px; }
  .lb-title h3 { margin:0; display:flex; align-items:center; gap:8px; }
  .toggle-wrap { display:flex; align-items:center; gap:3px; font-weight:600; }
  .toggle-wrap span { font-size:0.78em; opacity:0.9; }
  .toggle-btn {
    min-width:40px; height:24px; padding:0 8px; border:none; border-radius:14px; color:#fff; cursor:pointer;
    box-shadow:0 1px 3px rgba(0,0,0,0.15); font-weight:700; font-size:0.85em;
  }
  .toggle-btn.on  { background:var(--on); }
  .toggle-btn.off { background:var(--off); }

  /* Buttons / chips (colors sync with player card bg) */
  .pill-btn {
    display:inline-flex; align-items:center; justify-content:center;
    min-width:26px; height:24px; padding:0 10px;
    border:1px solid #c3dafe; border-radius:999px; background:#ffffff; color:#1e3a8a;
    font-weight:700; box-shadow:0 1px 3px rgba(0,0,0,0.15); font-size:0.9em; flex:0 0 auto;
  }
  .chip-btn {
    display:inline-flex; align-items:center; gap:6px;
    height:24px; padding:0 10px;
    border:1px solid #c3dafe; border-radius:999px; background:#ffffff; color:#1e3a8a;
    font-weight:700; box-shadow:0 1px 3px rgba(0,0,0,0.15); font-size:0.9em; flex:1 1 auto;
    min-width:0;
  }
  .chip-btn.big {
    height:32px; padding:0 14px; font-size:1rem; /* bigger for champion */
  }
  .name-text {
    display:inline-block; max-width:100%;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  /* Champion row layout */
  #leaderboard .champ-row {
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    margin:6px 0 8px 0;
  }
  #leaderboard .champ-left { display:flex; align-items:center; gap:8px; min-width:0; flex:1 1 auto; }
  #leaderboard .champ-right {
    text-align:right; font-size:1.05rem; font-weight:700; flex:0 0 auto;
  }
  .lb-divider {
    border:0; border-top:2px dashed rgba(0,0,0,0.08); margin:8px 0 6px 0;
  }

  /* Leader rows: first column 210px (rank + name) */
  #leaderboard .row {
    display:grid; grid-template-columns: 210px 1fr 24px; align-items:center;
    margin:2px 0; font-family:monospace; font-size:0.95rem;
  }
  #leaderboard .row .namecell {
    padding:2px 6px; border-radius:6px; display:flex; align-items:center; gap:6px;
    min-width:0; background:transparent !important;
  }

  .player-header { display:flex; align-items:center; justify-content:space-between; gap:6px; }
  .player-title { display:flex; align-items:center; gap:8px; }
  .avatar { margin:0; cursor:pointer; user-select:none; }
  .player-title input.player-name { font-size:1em; padding:2px 8px; border-radius:6px; border:1px solid #bbb; width:160px; }

  .reorder { display:flex; gap:6px; flex-wrap:wrap; }
  .icon-mini {
    width:32px; height:32px; font-size:0.95rem; padding:0; margin:0;
    border:none; border-radius:8px; background:#ffffff; color:#333;
    box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; transition:all .2s;
  }
  .icon-mini:hover { background:#e0f0ff; transform:scale(1.05); }

  .counter { display:flex; align-items:center; margin:8px 0; gap:8px; }
  .label { font-weight:bold; width:120px; }
  .pm {
    min-width:32px; height:28px; padding:0 6px;
    border:1px solid #cbd5e1; border-radius:8px; background:#fff; color:#111;
    box-shadow:0 2px 4px rgba(0,0,0,0.08);
    font-size:0.95rem; line-height:26px; cursor:pointer;
  }
  .pm:hover { background:#eef6ff; }
  .value-input { font-size:1rem; width:64px; text-align:center; padding:3px 6px; border-radius:6px; border:1px solid #ccc; }

  .toolbar {
    display:grid;
    grid-template-columns: repeat(5, 1fr);
    gap:8px;
    margin-top:8px;
  }
  .icon-btn {
    font-size:20px; width:100%; height:40px; display:flex; align-items:center; justify-content:center;
    padding:0; border:none; border-radius:8px; background:#ffffff; color:#333;
    box-shadow:0 2px 6px rgba(0,0,0,0.15); transition:all .2s; cursor:pointer;
  }
  .icon-btn:hover { background:#d0ebff; transform:scale(1.02); }
  .hidden { display:none !important; }

  .section { margin:6px 0; }
  .section .counter .remove-btn {
    width:28px; height:28px; font-size:1rem; padding:0;
    border:1px solid #f1aeb5; border-radius:8px; background:#fff; color:#b02a37;
    box-shadow:0 2px 4px rgba(0,0,0,0.08); cursor:pointer;
  }
  .section .counter .remove-btn:hover { background:#ffe2e5; }

  .controls { text-align:center; margin-bottom:12px; }
  .controls .value-input { width:64px; }

  .circle {
    background: linear-gradient(to bottom, #28a745, #218838);
    border: none; color: white; font-size: 1.05em;
    width: 56px; height: 56px; border-radius: 50%;
    box-shadow: 0 4px #1c7430; cursor:pointer;
  }
  .primary {
    font-size:0.95em; padding:8px 14px; border:none; border-radius:10px;
    background:var(--accent); color:#fff; cursor:pointer;
  }
  .primary:active { filter:brightness(0.92); }
  .btn-danger { background:#dc3545; color:white; font-size:0.95em; padding:8px 14px; border-radius:10px; border:none; box-shadow:0 4px #a71d2a; cursor:pointer; }

  .footer { height:90px; background:#f0f0f0; margin-top:10px; display:flex; flex-direction:column; justify-content:center; align-items:center; }

  .modal-mask { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:1000; }
  .modal { background:#fff; padding:16px; border-radius:12px; width:90%; max-width:360px; box-shadow:var(--shadow); }
  .modal h4 { margin:0 0 12px 0; }
  .modal .actions { display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }
  .btn-ghost { background:#f5f5f5; color:#333; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; }
</style>
</head>

<body>
  <div class="topbar">
    <a href="#" target="_blank">üìÑ Manual</a>
    <a href="#" target="_blank">üìú Rules</a>
    <a href="#" target="_blank">üß≠ Guide</a>
    <a href="#" target="_blank">‚ÑπÔ∏è About</a>
  </div>

  <h1>üß™ Cell Arena ATP Counter</h1>

  <div class="controls">
    <span id="label-turn" style="font-weight:bold;">Turn</span>
    <button class="pm" onclick="(function(){var el=document.getElementById('turn'); el.value=Math.max(1,(parseInt(el.value)||1)-1);})()">‚àí</button>
    <input class="value-input" id="turn" max="999" min="1" type="number" value="1"/>
    <button class="pm" onclick="(function(){var el=document.getElementById('turn'); el.value=(parseInt(el.value)||1)+1;})()">+</button>
    <span id="daynight" style="font-weight:bold; margin-left:16px;">üåû Day</span>
    <button id="switch-btn" style="margin-left: 8px;">Switch</button>
  </div>

  <div style="text-align:center; margin: 8px 0;">
    <button id="next-btn" class="circle">Next</button>
  </div>

  <div class="wrapper">
    <div id="leaderboard" class="panel">
      <div class="lb-head">
        <div class="lb-title"><h3>üèÜ Leaderboard</h3></div>
        <div class="toggle-wrap">
          <span>WTDGAP Expansion Pack</span>
          <button id="expansion-toggle" class="toggle-btn on">ON</button>
        </div>
      </div>
      <div>Loading‚Ä¶</div>
    </div>

    <div id="players-container">
      <div class="player" data-player="1">
        <div class="player-header">
          <div class="player-title">
            <h2 class="avatar" title="Click to change avatar">üë§</h2>
            <input class="player-name" value="Player 1" />
          </div>
          <div class="reorder">
            <button class="icon-mini paint-btn" title="Click: random color ‚Ä¢ Long press: reset to white">üé®</button>
            <button class="icon-mini" title="Move up">‚¨ÜÔ∏è</button>
            <button class="icon-mini" title="Move down">‚¨áÔ∏è</button>
            <button class="icon-mini" title="Delete player">üóëÔ∏è</button>
          </div>
        </div>

        <div class="counter" data-core="1">
          <span class="label">‚ö° ATP</span>
          <button class="pm">‚àí</button>
          <input class="value-input atp" max="999" min="0" type="number" value="20"/>
          <button class="pm">+</button>
        </div>
        <div class="counter" data-core="1">
          <span class="label">üçû Glucose</span>
          <button class="pm">‚àí</button>
          <input class="value-input glu" max="999" min="0" type="number" value="0"/>
          <button class="pm">+</button>
        </div>

        <div class="toolbar">
          <button class="icon-btn">üß¨</button>
          <button class="icon-btn">üî¨</button>
          <button class="icon-btn exp-core">ü¶†</button>
          <button class="icon-btn exp-core">‚ò£Ô∏é</button>
          <button class="icon-btn exp-core">üõ°Ô∏è</button>
          <button class="icon-btn expansion">‚òÅÔ∏è</button>
          <button class="icon-btn expansion">üî•</button>
          <button class="icon-btn expansion">üßä</button>
          <button class="icon-btn expansion">üëæ</button>
          <button class="icon-btn expansion">ü§ù</button>
        </div>

        <div class="section" data-type="mito"></div>
        <div class="section" data-type="cell"></div>
        <div class="section" data-type="infectA"></div>
        <div class="section" data-type="infectB"></div>
        <div class="section" data-type="immune"></div>
        <div class="section" data-type="overcast"></div>
        <div class="section" data-type="dry"></div>
        <div class="section" data-type="ice"></div>
        <div class="section" data-type="para"></div>
        <div class="section" data-type="coop"></div>
      </div>
    </div>

    <div style="text-align:center; margin-top:8px;">
      <button id="add-player-btn" class="primary">‚ûï Add Player</button>
    </div>
  </div>

  <div style="text-align:center; margin: 18px;">
    <button id="reset-btn" class="btn-danger">üîÅ Reset</button>
  </div>

  <div id="confirm-mask" class="modal-mask" role="dialog" aria-modal="true">
    <div class="modal">
      <h4>Delete Player</h4>
      <div>Are you sure you want to delete this player? This action cannot be undone.</div>
      <div class="actions">
        <button id="confirm-no" class="btn-ghost">Cancel</button>
        <button id="confirm-yes" class="btn-danger">Confirm Delete</button>
      </div>
    </div>
  </div>

  <audio id="click-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_b0b2e878c7.mp3"></audio>

  <div class="footer">
    <p style="font-size:14px; font-weight:bold; color:#555; margin:0;">Cell Arena Team</p>
    <div style="margin-top:4px;">
      <a href="#" target="_blank" style="margin:0 8px; font-size:12px; color:#333; text-decoration:none;">üíª GitHub</a>
      <a href="mailto:sciarena.team@gmail.com" style="margin:0 8px; font-size:12px; color:#333; text-decoration:none;">üìß Email</a>
      <a href="#" target="_blank" style="margin:0 8px; font-size:12px; color:#333; text-decoration:none;">üåê Website</a>
    </div>
  </div>

  <script>
  (function(){
    let isDay = true;
    let confirmTarget = null;
    let expansionOn = true;

    const avatarList = ['üë§','üê±','üê∂','üêº','ü¶ä','üêª','ü¶Å','üêØ','üêµ','üê∞','üêÆ','üê®','üßô','‚öîÔ∏è','üõ°Ô∏è'];
    function bindAvatar(card){
      const avatar = card.querySelector('.avatar');
      if(!avatar) return;
      avatar.addEventListener('click', ()=>{
        const curr = avatar.textContent;
        const idx = avatarList.indexOf(curr);
        const next = avatarList[(idx+1+avatarList.length)%avatarList.length];
        avatar.textContent = next;
      });
    }

    function rnd(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function randomPastel(){ const h=rnd(0,360), s=rnd(45,65), l=rnd(88,95); return `hsl(${h} ${s}% ${l}%)`; }
    function bindPaintButton(card){
      const paintBtn = card.querySelector('.paint-btn');
      if(!paintBtn) return;
      let pressTimer = null, longPressed = false;
      function clearTimer(){ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } }
      paintBtn.addEventListener('mousedown', ()=>{
        longPressed=false; pressTimer=setTimeout(()=>{ longPressed=true; card.style.background='#ffffff'; },600);
      });
      paintBtn.addEventListener('mouseup', ()=>{ if(!longPressed){ card.style.background = randomPastel(); } clearTimer(); });
      paintBtn.addEventListener('mouseleave', clearTimer);
      paintBtn.addEventListener('touchstart', ()=>{
        longPressed=false; pressTimer=setTimeout(()=>{ longPressed=true; card.style.background='#ffffff'; },600);
      }, {passive:true});
      paintBtn.addEventListener('touchend', ()=>{ if(!longPressed){ card.style.background = randomPastel(); } clearTimer(); });
      paintBtn.addEventListener('touchcancel', clearTimer);
    }

    function changeAdjacentInput(btn, delta, max=2048){
      const row = btn.closest('.counter');
      const input = row ? row.querySelector('input.value-input') : null;
      if(!input) return;
      let v = parseInt(input.value); v = isNaN(v) ? 0 : v;
      input.value = Math.max(0, Math.min(max, v+delta));
    }

    function toolbarButton(label, emoji, sectionType, def, classes) {
      const b = document.createElement('button');
      b.className = 'icon-btn ' + (classes || '');
      b.textContent = emoji;
      b.title = label;
      b.addEventListener('click', function(){
        const card = b.closest('.player');
        const section = card && card.querySelector('.section[data-type="'+sectionType+'"]');
        if(!section) return;
        const existingRows = section.querySelectorAll('.counter').length;
        if(existingRows >= 3) return;
        const div = document.createElement('div');
        div.className = 'counter';
        const labelHtml = '<span class="label">'+(sectionType==='coop' ? 'ü§ù Cooperation' : (emoji+' '+label))+'</span>';
        div.innerHTML = labelHtml +
                        '<button class="pm minus">‚àí</button>' +
                        '<input type="number" min="0" max="2048" value="'+def+'" class="value-input">' +
                        '<button class="pm plus">+</button>' +
                        '<button class="remove-btn" title="Delete">‚ùå</button>';
        section.appendChild(div);
        const minus = div.querySelector('button.minus');
        const plus  = div.querySelector('button.plus');
        const removeBtn = div.querySelector('button.remove-btn');
        minus.addEventListener('click', ()=>changeAdjacentInput(minus,-1,2048));
        plus.addEventListener('click', ()=>changeAdjacentInput(plus,1,2048));
        removeBtn.addEventListener('click', ()=>div.remove());
      });
      return b;
    }

    function applyExpansionVisibility(){
      const expBtns = document.querySelectorAll('.toolbar .expansion, .toolbar .exp-core');
      expBtns.forEach(btn => {
        if(expansionOn) btn.classList.remove('hidden');
        else btn.classList.add('hidden');
      });
      const toggle = document.getElementById('expansion-toggle');
      if(toggle){
        toggle.textContent = expansionOn ? 'ON' : 'OFF';
        toggle.classList.toggle('on', expansionOn);
        toggle.classList.toggle('off', !expansionOn);
      }
    }

    function bindPlayerCard(card){
      const upBtn   = card.querySelector('.reorder .icon-mini[title="Move up"]');
      const downBtn = card.querySelector('.reorder .icon-mini[title="Move down"]');
      const delBtn  = card.querySelector('.reorder .icon-mini[title="Delete player"]');
      const paintBtn= card.querySelector('.reorder .paint-btn');

      if(upBtn) upBtn.addEventListener('click', ()=>moveCard(card, -1));
      if(downBtn) downBtn.addEventListener('click', ()=>moveCard(card, 1));
      if(delBtn) delBtn.addEventListener('click', ()=>{ confirmTarget = card; openConfirm(); });
      if(paintBtn) bindPaintButton(card);

      bindAvatar(card);

      const coreRows = card.querySelectorAll('.counter[data-core="1"]');
      coreRows.forEach(row=>{
        const btns = row.querySelectorAll('button.pm');
        if(btns.length===2){
          const [minus, plus] = [btns[0], btns[1]];
          const isATP = !!row.querySelector('.atp');
          minus.addEventListener('click', ()=>changeAdjacentInput(minus,-1, isATP?999:2048));
          plus.addEventListener('click',  ()=>changeAdjacentInput(plus, 1, isATP?999:2048));
        }
      });

      const toolbar = card.querySelector('.toolbar');
      if(toolbar){
        toolbar.innerHTML = '';
        [
          ['Mitosis','üß¨','mito',5,''],
          ['Cell','üî¨','cell',1,''],
          ['Acute','ü¶†','infectA',3,'exp-core'],
          ['Chronic','‚ò£Ô∏é','infectB',5,'exp-core'],
          ['Immune','üõ°Ô∏è','immune',2,'exp-core'],
          ['Overcast','‚òÅÔ∏è','overcast',2,'expansion'],
          ['DrySeason','üî•','dry',2,'expansion'],
          ['IceAge','üßä','ice',4,'expansion'],
          ['Parasitism','üëæ','para',1,'expansion'],
          ['Cooperation','ü§ù','coop',2,'expansion'],
        ].forEach(args=> toolbar.appendChild(toolbarButton(...args)));
      }
      applyExpansionVisibility();
    }

    function moveCard(card, dir){
      const container = document.getElementById('players-container');
      if(!container) return;
      const cards = Array.from(container.querySelectorAll('.player'));
      const i = cards.indexOf(card);
      const j = i + dir;
      if(j<0 || j>=cards.length) return;
      container.removeChild(card);
      if(dir<0){ container.insertBefore(card, cards[j]); }
      else {
        if(cards[j].nextSibling) container.insertBefore(card, cards[j].nextSibling);
        else container.appendChild(card);
      }
      reindex();
    }

    function openConfirm(){ const mask = document.getElementById('confirm-mask'); if(mask) mask.style.display = 'flex'; }
    function closeConfirm(){ const mask = document.getElementById('confirm-mask'); if(mask) mask.style.display = 'none'; confirmTarget = null; }

    function reindex(){
      const container = document.getElementById('players-container');
      if(!container) return;
      const cards = Array.from(container.querySelectorAll('.player'));
      cards.forEach((c, i)=>{
        c.setAttribute('data-player', String(i+1));
        const nameInput = c.querySelector('input.player-name');
        if(nameInput && /^Player\s*\d*$/.test((nameInput.value||'').trim())){
          nameInput.value = 'Player ' + (i+1);
        }
      });
      updateAddPlayerButton();
    }

    function addPlayer(){
      const container = document.getElementById('players-container');
      if(!container) return;
      const count = container.querySelectorAll('.player').length;
      if(count >= 6){ alert('Up to 6 players'); return; }
      const card = createEmptyCard();
      container.appendChild(card);
      bindPlayerCard(card);
      reindex();
    }

    function createEmptyCard(){
      const card = document.createElement('div');
      card.className = 'player';
      card.innerHTML = [
        '<div class="player-header">',
          '<div class="player-title">',
            '<h2 class="avatar" title="Click to change avatar">üë§</h2>',
            '<input class="player-name" value="Player " />',
          '</div>',
          '<div class="reorder">',
            '<button class="icon-mini paint-btn" title="Click: random color ‚Ä¢ Long press: reset to white">üé®</button>',
            '<button class="icon-mini" title="Move up">‚¨ÜÔ∏è</button>',
            '<button class="icon-mini" title="Move down">‚¨áÔ∏è</button>',
            '<button class="icon-mini" title="Delete player">üóëÔ∏è</button>',
          '</div>',
        '</div>',
        '<div class="counter" data-core="1">',
          '<span class="label">‚ö° ATP</span>',
          '<button class="pm">‚àí</button>',
          '<input class="value-input atp" max="999" min="0" type="number" value="20"/>',
          '<button class="pm">+</button>',
        '</div>',
        '<div class="counter" data-core="1">',
          '<span class="label">üçû Glucose</span>',
          '<button class="pm">‚àí</button>',
          '<input class="value-input glu" max="999" min="0" type="number" value="0"/>',
          '<button class="pm">+</button>',
        '</div>',
        '<div class="toolbar"></div>',
        '<div class="section" data-type="mito"></div>',
        '<div class="section" data-type="cell"></div>',
        '<div class="section" data-type="infectA"></div>',
        '<div class="section" data-type="infectB"></div>',
        '<div class="section" data-type="immune"></div>',
        '<div class="section" data-type="overcast"></div>',
        '<div class="section" data-type="dry"></div>',
        '<div class="section" data-type="ice"></div>',
        '<div class="section" data-type="para"></div>',
        '<div class="section" data-type="coop"></div>',
      ].join('');
      return card;
    }

    function updateLeaderboard(){
      const board = document.getElementById('leaderboard');
      const container = document.getElementById('players-container');
      if(!board || !container) return;
      const cards = Array.from(container.querySelectorAll('.player'));
      if(cards.length===0){
        board.innerHTML = '<div class="lb-head">'+
          '<div class="lb-title"><h3>üèÜ Leaderboard</h3></div>'+
          '<div class="toggle-wrap"><span>WTDGAP Expansion Pack</span><button id="expansion-toggle" class="toggle-btn '+(expansionOn?'on">ON':'off">OFF')+'</button></div>'+
          '</div><div>No players</div>';
        bindExpansionToggle();
        return;
      }
      const players = cards.map((card,i)=>{
        const name = (card.querySelector('input.player-name')?.value || ('Player '+(i+1))).trim();
        const avatar = (card.querySelector('.avatar')?.textContent || 'üë§').trim();
        const atp = parseInt(card.querySelector('input.atp')?.value) || 0;
        const glu = parseInt(card.querySelector('input.glu')?.value) || 0;
        const bg = (card.style.background && card.style.background.trim()) || '#ffffff';
        return {name, avatar, atp, glu, bg};
      }).sort((a,b)=> b.atp-a.atp || b.glu-a.glu);
      const champ = players[0];

      function chipStyles(bg){ return 'style="background:'+bg+';"'; }

      board.innerHTML =
        '<div class="lb-head">'+
          '<div class="lb-title"><h3>üèÜ Leaderboard</h3></div>'+
          '<div class="toggle-wrap"><span>WTDGAP Expansion Pack</span><button id="expansion-toggle" class="toggle-btn '+(expansionOn?'on">ON':'off">OFF')+'</button></div>'+
        '</div>' +
        // Champion section: NO rank pill, bigger name chip, stats on right
        '<div class="champ-row">'+
          '<div class="champ-left">'+
            '<span class="chip-btn big" '+chipStyles(champ.bg)+' title="Champion">'+champ.avatar+' <b class="name-text">'+champ.name+'</b></span>'+
          '</div>'+
          '<div class="champ-right">‚ö° '+champ.atp+' &nbsp; | &nbsp; üçû '+champ.glu+'</div>'+
        '</div>'+
        '<hr class="lb-divider" />' +
        // List
        players.map((p,i)=>
          '<div class="row">'+
            '<div class="namecell">'+
              '<span class="pill-btn" '+chipStyles(p.bg)+' title="Rank '+(i+1)+'">'+(i+1)+'</span> '+
              '<span class="chip-btn" '+chipStyles(p.bg)+' title="Player">'+p.avatar+' <b class="name-text">'+p.name+'</b></span>'+
            '</div>'+
            '<div style="text-align:right;">ATP '+String(p.atp).padStart(3)+' | Glu '+String(p.glu).padStart(3)+'</div>'+
            '<div>üèÖ</div>'+
          '</div>'
        ).join('');

      bindExpansionToggle();
    }

    function bindExpansionToggle(){
      const btn = document.getElementById('expansion-toggle');
      if(!btn) return;
      btn.addEventListener('click', ()=>{
        expansionOn = !expansionOn;
        applyExpansionVisibility();
        updateLeaderboard();
      });
    }

    function updateAddPlayerButton(){
      const container = document.getElementById('players-container');
      const btn = document.getElementById('add-player-btn');
      if(!container || !btn) return;
      const count = container.querySelectorAll('.player').length;
      if(count>=6){ btn.disabled=true; btn.textContent='Player cap reached (6)'; }
      else { btn.disabled=false; btn.textContent='‚ûï Add Player'; }
    }

    function resetGame(){
      const turn = document.getElementById('turn'); if(turn) turn.value = 1;
      const day = document.getElementById('daynight'); if(day) day.textContent = 'üåû Day';
      isDay = true;
      const container = document.getElementById('players-container');
      if(container){
        const cards = Array.from(container.querySelectorAll('.player'));
        cards.forEach((card,i)=>{
          const atp = card.querySelector('input.atp'); if(atp) atp.value = 20;
          const glu = card.querySelector('input.glu'); if(glu) glu.value = 0;
          card.querySelectorAll('.section').forEach(sec=> sec.innerHTML='');
          const name = card.querySelector('input.player-name');
          if(name && /^Player\s*\d*$/.test((name.value||'').trim())) name.value = 'Player ' + (i+1);
          /* keep player card background color (do not reset) */
        });
      }
      reindex();
    }

    document.getElementById('add-player-btn')?.addEventListener('click', addPlayer);
    document.getElementById('reset-btn')?.addEventListener('click', resetGame);
    document.getElementById('switch-btn')?.addEventListener('click', function(){
      isDay = !isDay;
      const day = document.getElementById('daynight');
      if(day) day.textContent = isDay ? 'üåû Day' : 'üåô Night';
    });
    document.getElementById('next-btn')?.addEventListener('click', function(){
      const turn = document.getElementById('turn');
      if(turn) turn.value = (parseInt(turn.value)||1) + 1;
      const day = document.getElementById('daynight');
      if(day) day.textContent = isDay ? 'üåô Night' : 'üåû Day';
      isDay = !isDay;
      const audio = document.getElementById('click-sound'); if(audio){ audio.currentTime=0; audio.play(); }
    });

    const firstCard = document.querySelector('#players-container .player');
    if(firstCard) { bindPlayerCard(firstCard); }
    reindex();
    updateAddPlayerButton();
    applyExpansionVisibility();
    updateLeaderboard();
    setInterval(updateLeaderboard, 800);

    document.getElementById('confirm-no')?.addEventListener('click', closeConfirm);
    document.getElementById('confirm-yes')?.addEventListener('click', function(){
      if(confirmTarget && confirmTarget.parentElement) confirmTarget.parentElement.removeChild(confirmTarget);
      closeConfirm();
      reindex();
    });
  })();
  </script>
</body>
</html>
