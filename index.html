
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Cell Arena ATP Counter (Dynamic Players v3.4)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  :root {
    --accent: #1976d2;
    --border: #d8dee9;
    --text: #1f2937;
    --shadow: 0 2px 6px rgba(0,0,0,0.06);
    --on: #2e7d32;
    --off: #b00020;
  }
  * { box-sizing: border-box; }
  body { font-family: "Segoe UI", "PingFang SC", "Microsoft Yahei", sans-serif; margin:0; background:#f8fbff; color:var(--text); }
  h1 { text-align:center; color:#1a2c43; margin:16px 0; }

  .topbar { background:#f0f0f0; padding:10px; text-align:center; }
  .topbar a { margin:0 10px; font-size:14px; color:#333; text-decoration:none; }

  .wrapper { width:100%; display:flex; flex-direction:column; align-items:center; padding:10px; }

  .panel, .player {
    width:400px;
    margin:14px auto;
    background:#fff;
    border:2px solid var(--border);
    border-radius:12px;
    box-shadow:var(--shadow);
    padding:12px;
  }
  #leaderboard { background:#e3f2fd; }

  .lb-head {
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    margin-bottom:6px;
  }
  .lb-title { display:flex; align-items:center; gap:8px; }
  .lb-title h3 { margin:0; display:flex; align-items:center; gap:8px; }
  .toggle-wrap { display:flex; align-items:center; gap:3px; font-weight:600; }
  .toggle-wrap span { font-size:0.78em; opacity:0.9; }
  .toggle-btn {
    min-width:40px; height:24px; padding:0 8px; border:none; border-radius:14px; color:#fff; cursor:pointer;
    box-shadow:0 1px 3px rgba(0,0,0,0.15); font-weight:700; font-size:0.85em;
  }
  .toggle-btn.on  { background:var(--on); }
  .toggle-btn.off { background:var(--off); }

  /* Buttons / chips (colors sync with player card bg) */
  .pill-btn {
    display:inline-flex; align-items:center; justify-content:center;
    min-width:26px; height:24px; padding:0 10px;
    border:1px solid #c3dafe; border-radius:999px; background:#ffffff; color:#1e3a8a;
    font-weight:700; box-shadow:0 1px 3px rgba(0,0,0,0.15); font-size:0.9em; flex:0 0 auto;
  }
  .chip-btn {
    display:inline-flex; align-items:center; gap:6px;
    height:24px; padding:0 10px;
    border:1px solid #c3dafe; border-radius:999px; background:#ffffff; color:#1e3a8a;
    font-weight:700; box-shadow:0 1px 3px rgba(0,0,0,0.15); font-size:0.9em; flex:1 1 auto;
    min-width:0;
  }
  .chip-btn.big {
    height:32px; padding:0 14px; font-size:1rem; /* bigger for champion */
  }
  .name-text {
    display:inline-block; max-width:100%;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  /* Champion row layout */
  #leaderboard .champ-row {
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    margin:6px 0 8px 0;
  }
  #leaderboard .champ-left { display:flex; align-items:center; gap:8px; min-width:0; flex:1 1 auto; }
  #leaderboard .champ-right {
    text-align:right; font-size:1.05rem; font-weight:700; flex:0 0 auto;
  }
  .lb-divider {
    border:0; border-top:2px dashed rgba(0,0,0,0.08); margin:8px 0 6px 0;
  }

  /* Leader rows: first column 210px (rank + name) */
  #leaderboard .row {
    display:grid; grid-template-columns: 210px 1fr 24px; align-items:center;
    margin:2px 0; font-family:monospace; font-size:0.95rem;
  }
  #leaderboard .row .namecell {
    padding:2px 6px; border-radius:6px; display:flex; align-items:center; gap:6px;
    min-width:0; background:transparent !important;
  }

  .player-header { display:flex; align-items:center; justify-content:space-between; gap:6px; }
  .player-title { display:flex; align-items:center; gap:8px; }
  .avatar { margin:0; cursor:pointer; user-select:none; }
  .player-title input.player-name { font-size:1em; padding:2px 8px; border-radius:6px; border:1px solid #bbb; width:160px; }

  .reorder { display:flex; gap:6px; flex-wrap:wrap; }
  .icon-mini {
    width:32px; height:32px; font-size:0.95rem; padding:0; margin:0;
    border:none; border-radius:8px; background:#ffffff; color:#333;
    box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; transition:all .2s;
  }
  .icon-mini:hover { background:#e0f0ff; transform:scale(1.05); }

  .counter { display:flex; align-items:center; margin:8px 0; gap:8px; }
  .label { font-weight:bold; width:120px; }
  .pm {
    min-width:32px; height:28px; padding:0 6px;
    border:1px solid #cbd5e1; border-radius:8px; background:#fff; color:#111;
    box-shadow:0 2px 4px rgba(0,0,0,0.08);
    font-size:0.95rem; line-height:26px; cursor:pointer;
  }
  .pm:hover { background:#eef6ff; }
  .value-input { font-size:1rem; width:64px; text-align:center; padding:3px 6px; border-radius:6px; border:1px solid #ccc; }

  .toolbar {
    display:grid;
    grid-template-columns: repeat(5, 1fr);
    gap:8px;
    margin-top:8px;
  }
  .icon-btn {
    font-size:20px; width:100%; height:40px; display:flex; align-items:center; justify-content:center;
    padding:0; border:none; border-radius:8px; background:#ffffff; color:#333;
    box-shadow:0 2px 6px rgba(0,0,0,0.15); transition:all .2s; cursor:pointer;
  }
  .icon-btn:hover { background:#d0ebff; transform:scale(1.02); }
  .hidden { display:none !important; }

  .section { margin:6px 0; }
  .section .counter .remove-btn {
    width:28px; height:28px; font-size:1rem; padding:0;
    border:1px solid #f1aeb5; border-radius:8px; background:#fff; color:#b02a37;
    box-shadow:0 2px 4px rgba(0,0,0,0.08); cursor:pointer;
  }
  .section .counter .remove-btn:hover { background:#ffe2e5; }

  .controls { text-align:center; margin-bottom:12px; }
  .controls .value-input { width:64px; }

  .circle {
    background: linear-gradient(to bottom, #28a745, #218838);
    border: none; color: white; font-size: 1.05em;
    width: 56px; height: 56px; border-radius: 50%;
    box-shadow: 0 4px #1c7430; cursor:pointer;
  }
  .primary {
    font-size:0.95em; padding:8px 14px; border:none; border-radius:10px;
    background:var(--accent); color:#fff; cursor:pointer;
  }
  .primary:active { filter:brightness(0.92); }
  .btn-danger { background:#dc3545; color:white; font-size:0.95em; padding:8px 14px; border-radius:10px; border:none; box-shadow:0 4px #a71d2a; cursor:pointer; }

  .footer { height:90px; background:#f0f0f0; margin-top:10px; display:flex; flex-direction:column; justify-content:center; align-items:center; }

  .modal-mask { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:1000; }
  .modal { background:#fff; padding:16px; border-radius:12px; width:90%; max-width:360px; box-shadow:var(--shadow); }
  .modal h4 { margin:0 0 12px 0; }
  .modal .actions { display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }
  .btn-ghost { background:#f5f5f5; color:#333; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; }

/* === Long-press (2000ms) drag to reorder on blank area === */
.player.dragging {
  position: absolute !important;
  width: 400px; /* keep card width consistent */
  transform: scale(1.01);
  box-shadow: 0 14px 30px rgba(16,24,40,.28) !important;
  cursor: grabbing !important;
  z-index: 1000;
}
.player.placeholder {
  border: 2px dashed #a7c5eb;
  background: transparent !important;
  height: var(--ph, 140px);
  border-radius: 12px;
  margin: 14px auto;
}
.player.hold-hint {
  animation: holdPulse 1s ease-in-out infinite;
}
@keyframes holdPulse {
  0%   { box-shadow: 0 0 0 0 rgba(25,118,210,0.0); }
  50%  { box-shadow: 0 0 0 6px rgba(25,118,210,0.18); }
  100% { box-shadow: 0 0 0 0 rgba(25,118,210,0.0); }
}


/* === Long-press tip bubble === */
.player { position: relative; } /* allow absolute-positioned tip */
.player .hold-tip {
  position: absolute;
  left: 50%;
  top: -10px;
  transform: translate(-50%, -100%);
  padding: 6px 10px;
  background: rgba(17, 24, 39, 0.92);
  color: #fff;
  border-radius: 8px;
  font-size: 12px;
  white-space: nowrap;
  box-shadow: 0 2px 8px rgba(0,0,0,.25);
  pointer-events: none;
  opacity: 0;
  animation: tipFade .18s ease forwards;
  z-index: 5;
}
.player .hold-tip::after {
  content: "";
  position: absolute;
  bottom: -6px;
  left: 50%;
  transform: translateX(-50%);
  border-width: 6px 6px 0 6px;
  border-style: solid;
  border-color: rgba(17,24,39,0.92) transparent transparent transparent;
}
@keyframes tipFade {
  from { opacity: 0; transform: translate(-50%, -110%); }
  to   { opacity: 1; transform: translate(-50%, -100%); }
}




/* === Glass Buttons v3.8 === */
.glass-btn{position:relative;display:inline-flex;align-items:center;justify-content:center;gap:.4rem;padding:10px 16px;border-radius:14px;font-weight:700;letter-spacing:.2px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);box-shadow:inset 1px 1px 3px rgba(255,255,255,.18),inset -1px -1px 3px rgba(0,0,0,.18),0 4px 12px rgba(0,0,0,.22);cursor:pointer;transition:transform .2s ease,box-shadow .3s ease,background .3s ease,border-color .3s ease;}
.glass-btn.green{background:radial-gradient(140% 140% at 30% 20%,rgba(60,190,110,.85) 0%,rgba(30,150,70,.85) 60%,rgba(18,92,42,.9) 100%);border-color:rgba(30,150,70,.45);box-shadow:0 0 0 2px rgba(80,230,140,.25) inset,0 8px 20px rgba(18,92,42,.45),0 2px 12px rgba(0,0,0,.18)}
.glass-btn.green:hover{background:radial-gradient(140% 140% at 30% 20%,rgba(60,200,115,.92) 0%,rgba(30,160,75,.92) 60%,rgba(18,92,42,.95) 100%);box-shadow:0 0 0 3px rgba(80,230,140,.32) inset,0 12px 28px rgba(18,92,42,.55),0 4px 16px rgba(0,0,0,.22);transform:translateY(-1px)}
.glass-btn.red{background:radial-gradient(140% 140% at 30% 20%,rgba(255,120,132,.95) 0%,rgba(220,53,69,.92) 60%,rgba(140,0,24,.96) 100%);border-color:rgba(176,0,32,.5);box-shadow:0 0 0 2px rgba(255,120,132,.35) inset,0 10px 24px rgba(176,0,32,.45),0 4px 14px rgba(0,0,0,.18)}
.glass-btn.red:hover{box-shadow:0 0 0 4px rgba(255,120,132,.45) inset,0 16px 36px rgba(176,0,32,.55),0 6px 20px rgba(0,0,0,.26);transform:translateY(-1px)}
.glass-btn.circle{width:78px;height:78px;border-radius:50%;font-size:1.05rem;font-weight:800;line-height:1;padding:0}
.glass-btn.circle.green:hover{animation:breathe 1.6s ease-in-out infinite}
@keyframes breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
.center-row{display:flex;justify-content:center;align-items:center;gap:10px}

</style>
</head>

<bodystyle=" max-width: 1250px; margin: 0 auto;">
  <!-- 顶部导航区域 -->
<div style="background:#f0f0f0; padding: 10px; text-align:center;">
  <a href="https://mp.weixin.qq.com/s/echWb-6CIUU1hnVUyQiF0A" target="_blank"
     style="margin: 0 10px; font-size:14px; color:#333; text-decoration:none;">📄 Manual</a>
  <a href="https://mp.weixin.qq.com/s/4R_AuXsxTG752rNBpNUALQ" target="_blank"
     style="margin: 0 10px; font-size:14px; color:#333; text-decoration:none;">📜 Rules</a>
  <a href="https://mp.weixin.qq.com/s/6rHPx3pbmoM_bQaaHwhe7A" target="_blank"
     style="margin: 0 10px; font-size:14px; color:#333; text-decoration:none;">🧭 Guide</a>
  <a href="https://mp.weixin.qq.com/s/FKWpYsSEOCHACpNHa_Zgwg" target="_blank"
     style="margin: 0 10px; font-size:14px; color:#333; text-decoration:none;">ℹ️ About</a>
</div>
  <h1>🧪 Cell Arena ATP Counter</h1>

  <div class="controls">
    <span id="label-turn" style="font-weight:bold;">Turn</span>
    <button class="pm" onclick="(function(){var el=document.getElementById('turn'); el.value=Math.max(1,(parseInt(el.value)||1)-1);})()">−</button>
    <input class="value-input" id="turn" max="999" min="1" type="number" value="1"/>
    <button class="pm" onclick="(function(){var el=document.getElementById('turn'); el.value=(parseInt(el.value)||1)+1;})()">+</button>
    <span id="daynight" style="font-weight:bold; margin-left:16px;">🌞 Day</span>
    <button id="switch-btn" style="margin-left: 8px;">Switch</button>
  </div>

  
<div class="center-row"><div class="center-row"><button class="circle btn-glass btn-glass--green-circle btn-glass btn-glass--green-circle glass-btn circle green" onclick="playSound(); nextTurn()"  id="next-btn">Next</button></div></div>


  <div class="wrapper">
    <div id="leaderboard" class="panel">
      <div class="lb-head">
        <div class="lb-title"><h3>🏆 Leaderboard</h3></div>
        <div class="toggle-wrap">
          <span>WTDGAP Expansion Pack</span>
          <button id="expansion-toggle" class="toggle-btn on">ON</button>
        </div>
      </div>
      <div>Loading…</div>
    </div>

    <div id="players-container">
      <div class="player" data-player="1">
        <div class="player-header">
          <div class="player-title">
            <h2 class="avatar" title="Click to change avatar">👤</h2>
            <input class="player-name" value="Player 1" />
          </div>
          <div class="reorder">
            <button class="icon-mini paint-btn" title="Click: random color • Long press: reset to white">🎨</button>
            <button class="icon-mini" title="Delete player">🗑️</button>
          </div>
        </div>

        <div class="counter" data-core="1">
          <span class="label">⚡ ATP</span>
          <button class="pm">−</button>
          <input class="value-input atp" max="999" min="0" type="number" value="20"/>
          <button class="pm">+</button>
        </div>
        <div class="counter" data-core="1">
          <span class="label">🍞 Glucose</span>
          <button class="pm">−</button>
          <input class="value-input glu" max="999" min="0" type="number" value="0"/>
          <button class="pm">+</button>
        </div>

        <div class="toolbar">
          <button class="icon-btn">🧬</button>
          <button class="icon-btn">🔬</button>
          <button class="icon-btn exp-core">🦠</button>
          <button class="icon-btn exp-core">☣︎</button>
          <button class="icon-btn exp-core">🛡️</button>
          <button class="icon-btn expansion">☁️</button>
          <button class="icon-btn expansion">🔥</button>
          <button class="icon-btn expansion">🧊</button>
          <button class="icon-btn expansion">👾</button>
          <button class="icon-btn expansion">🤝</button>
        </div>

        <div class="section" data-type="mito"></div>
        <div class="section" data-type="cell"></div>
        <div class="section" data-type="infectA"></div>
        <div class="section" data-type="infectB"></div>
        <div class="section" data-type="immune"></div>
        <div class="section" data-type="overcast"></div>
        <div class="section" data-type="dry"></div>
        <div class="section" data-type="ice"></div>
        <div class="section" data-type="para"></div>
        <div class="section" data-type="coop"></div>
      </div>
    </div>

    <div style="text-align:center; margin-top:8px;">
      <button id="add-player-btn" class="primary glass-btn green" class="btn-glass btn-glass--clear" class="btn-glass btn-glass--clear" class="btn-glass btn-glass--clear" onclick="addPlayer()">➕ Add Player</button>
    </div>
  </div>

  <div style="text-align:center; margin: 18px;">
    <button id="reset-btn" class="btn-danger glass-btn red" class="btn-glass btn-glass--red" onclick="resetGame()">🔁 Restart Game</button>
  </div>

  <div id="confirm-mask" class="modal-mask" role="dialog" aria-modal="true">
    <div class="modal">
      <h4>Delete Player</h4>
      <div>Are you sure you want to delete this player? This action cannot be undone.</div>
      <div class="actions">
        <button id="confirm-no" class="btn-ghost">Cancel</button>
        <button id="confirm-yes" class="btn-danger">Confirm Delete</button>
      </div>
    </div>
  </div>

  <audio id="click-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_b0b2e878c7.mp3"></audio>

  <div class="footer">
    <p style="font-size:14px; font-weight:bold; color:#555; margin:0;">SciArena LLC Team</p>
   <div style="margin-top: 4px;">
    <a href="https://github.com/ifblack/cell-arena-counter" target="_blank"
   style="margin: 0 10px; font-size:14px; color:#333; text-decoration:none;">💻 GitHub</a>
    <a href="mailto:sciarena.team@gmail.com"
      style="margin: 0 10px; font-size:14px; color:#333; text-decoration:none;">📧 Email</a>
    <a href="https://www.sciarenalabs.com/" target="_blank"
      style="margin: 0 10px; font-size:14px; color:#333; text-decoration:none;">🌐 Website</a>
  </div>

  <script>
  (function(){
    let isDay = true;
    let confirmTarget = null;
    let expansionOn = true;

    const avatarList = ['👤','🐱','🐶','🐼','🦊','🐻','🦁','🐯','🐵','🐰','🐮','🐨','🧙','⚔️','🛡️'];
    function bindAvatar(card){
      const avatar = card.querySelector('.avatar');
      if(!avatar) return;
      avatar.addEventListener('click', ()=>{
        const curr = avatar.textContent;
        const idx = avatarList.indexOf(curr);
        const next = avatarList[(idx+1+avatarList.length)%avatarList.length];
        avatar.textContent = next;
      });
    }

    function rnd(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function randomPastel(){ const h=rnd(0,360), s=rnd(45,65), l=rnd(88,95); return `hsl(${h} ${s}% ${l}%)`; }
    function bindPaintButton(card){
      const paintBtn = card.querySelector('.paint-btn');
      if(!paintBtn) return;
      let pressTimer = null, longPressed = false;
      function clearTimer(){ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } }
      paintBtn.addEventListener('mousedown', ()=>{
        longPressed=false; pressTimer=setTimeout(()=>{ longPressed=true; card.style.background='#ffffff'; },600);
      });
      paintBtn.addEventListener('mouseup', ()=>{ if(!longPressed){ card.style.background = randomPastel(); } clearTimer(); });
      paintBtn.addEventListener('mouseleave', clearTimer);
      paintBtn.addEventListener('touchstart', ()=>{
        longPressed=false; pressTimer=setTimeout(()=>{ longPressed=true; card.style.background='#ffffff'; },600);
      }, {passive:true});
      paintBtn.addEventListener('touchend', ()=>{ if(!longPressed){ card.style.background = randomPastel(); } clearTimer(); });
      paintBtn.addEventListener('touchcancel', clearTimer);
    }

    function changeAdjacentInput(btn, delta, max=2048){
      const row = btn.closest('.counter');
      const input = row ? row.querySelector('input.value-input') : null;
      if(!input) return;
      let v = parseInt(input.value); v = isNaN(v) ? 0 : v;
      input.value = Math.max(0, Math.min(max, v+delta));
    }

    function toolbarButton(label, emoji, sectionType, def, classes) {
      const b = document.createElement('button');
      b.className = 'icon-btn ' + (classes || '');
      b.textContent = emoji;
      b.title = label;
      b.addEventListener('click', function(){
        const card = b.closest('.player');
        const section = card && card.querySelector('.section[data-type="'+sectionType+'"]');
        if(!section) return;
        const existingRows = section.querySelectorAll('.counter').length;
        if(existingRows >= 3) return;
        const div = document.createElement('div');
        div.className = 'counter';
        const labelHtml = '<span class="label">'+(sectionType==='coop' ? '🤝 Cooperation' : (emoji+' '+label))+'</span>';
        div.innerHTML = labelHtml +
                        '<button class="pm minus">−</button>' +
                        '<input type="number" min="0" max="2048" value="'+def+'" class="value-input">' +
                        '<button class="pm plus">+</button>' +
                        '<button class="remove-btn" title="Delete">❌</button>';
        section.appendChild(div);
        const minus = div.querySelector('button.minus');
        const plus  = div.querySelector('button.plus');
        const removeBtn = div.querySelector('button.remove-btn');
        minus.addEventListener('click', ()=>changeAdjacentInput(minus,-1,2048));
        plus.addEventListener('click', ()=>changeAdjacentInput(plus,1,2048));
        removeBtn.addEventListener('click', ()=>div.remove());
      });
      return b;
    }

    function applyExpansionVisibility(){
      const expBtns = document.querySelectorAll('.toolbar .expansion, .toolbar .exp-core');
      expBtns.forEach(btn => {
        if(expansionOn) btn.classList.remove('hidden');
        else btn.classList.add('hidden');
      });
      const toggle = document.getElementById('expansion-toggle');
      if(toggle){
        toggle.textContent = expansionOn ? 'ON' : 'OFF';
        toggle.classList.toggle('on', expansionOn);
        toggle.classList.toggle('off', !expansionOn);
      }
    }

    function bindPlayerCard(card){
      const upBtn   = card.querySelector('.reorder .icon-mini[title="Move up"]');
      const downBtn = card.querySelector('.reorder .icon-mini[title="Move down"]');
      const delBtn  = card.querySelector('.reorder .icon-mini[title="Delete player"]');
      const paintBtn= card.querySelector('.reorder .paint-btn');

      if(upBtn) upBtn.addEventListener('click', ()=>moveCard(card, -1));
      if(downBtn) downBtn.addEventListener('click', ()=>moveCard(card, 1));
      if(delBtn) delBtn.addEventListener('click', ()=>{ confirmTarget = card; openConfirm(); });
      if(paintBtn) bindPaintButton(card);

      bindAvatar(card);

      const coreRows = card.querySelectorAll('.counter[data-core="1"]');
      coreRows.forEach(row=>{
        const btns = row.querySelectorAll('button.pm');
        if(btns.length===2){
          const [minus, plus] = [btns[0], btns[1]];
          const isATP = !!row.querySelector('.atp');
          minus.addEventListener('click', ()=>changeAdjacentInput(minus,-1, isATP?999:2048));
          plus.addEventListener('click',  ()=>changeAdjacentInput(plus, 1, isATP?999:2048));
        }
      });

      const toolbar = card.querySelector('.toolbar');
      if(toolbar){
        toolbar.innerHTML = '';
        [
          ['Mitosis','🧬','mito',5,''],
          ['Cell','🔬','cell',1,''],
          ['Acute','🦠','infectA',3,'exp-core'],
          ['Chronic','☣︎','infectB',5,'exp-core'],
          ['Immune','🛡️','immune',2,'exp-core'],
          ['Overcast','☁️','overcast',2,'expansion'],
          ['DrySeason','🔥','dry',2,'expansion'],
          ['IceAge','🧊','ice',4,'expansion'],
          ['Parasitism','👾','para',1,'expansion'],
          ['Cooperation','🤝','coop',2,'expansion'],
        ].forEach(args=> toolbar.appendChild(toolbarButton(...args)));
      }
      applyExpansionVisibility();
    }

    function moveCard(card, dir){
      const container = document.getElementById('players-container');
      if(!container) return;
      const cards = Array.from(container.querySelectorAll('.player'));
      const i = cards.indexOf(card);
      const j = i + dir;
      if(j<0 || j>=cards.length) return;
      container.removeChild(card);
      if(dir<0){ container.insertBefore(card, cards[j]); }
      else {
        if(cards[j].nextSibling) container.insertBefore(card, cards[j].nextSibling);
        else container.appendChild(card);
      }
      reindex();
    }

    function openConfirm(){ const mask = document.getElementById('confirm-mask'); if(mask) mask.style.display = 'flex'; }
    function closeConfirm(){ const mask = document.getElementById('confirm-mask'); if(mask) mask.style.display = 'none'; confirmTarget = null; }

    function reindex(){
      const container = document.getElementById('players-container');
      if(!container) return;
      const cards = Array.from(container.querySelectorAll('.player'));
      cards.forEach((c, i)=>{
        c.setAttribute('data-player', String(i+1));
        const nameInput = c.querySelector('input.player-name');
        if(nameInput && /^Player\s*\d*$/.test((nameInput.value||'').trim())){
          nameInput.value = 'Player ' + (i+1);
        }
      });
      updateAddPlayerButton();
    }

    function addPlayer(){
      const container = document.getElementById('players-container');
      if(!container) return;
      const count = container.querySelectorAll('.player').length;
      if(count >= 6){ alert('Up to 6 players'); return; }
      const card = createEmptyCard();
      container.appendChild(card);
      bindPlayerCard(card);
      reindex();
    }

    function createEmptyCard(){
      const card = document.createElement('div');
      card.className = 'player';
      card.innerHTML = [
        '<div class="player-header">',
          '<div class="player-title">',
            '<h2 class="avatar" title="Click to change avatar">👤</h2>',
            '<input class="player-name" value="Player " />',
          '</div>',
          '<div class="reorder">',
            '<button class="icon-mini paint-btn" title="Click: random color • Long press: reset to white">🎨</button>',
            '<button class="icon-mini" title="Delete player">🗑️</button>',
          '</div>',
        '</div>',
        '<div class="counter" data-core="1">',
          '<span class="label">⚡ ATP</span>',
          '<button class="pm">−</button>',
          '<input class="value-input atp" max="999" min="0" type="number" value="20"/>',
          '<button class="pm">+</button>',
        '</div>',
        '<div class="counter" data-core="1">',
          '<span class="label">🍞 Glucose</span>',
          '<button class="pm">−</button>',
          '<input class="value-input glu" max="999" min="0" type="number" value="0"/>',
          '<button class="pm">+</button>',
        '</div>',
        '<div class="toolbar"></div>',
        '<div class="section" data-type="mito"></div>',
        '<div class="section" data-type="cell"></div>',
        '<div class="section" data-type="infectA"></div>',
        '<div class="section" data-type="infectB"></div>',
        '<div class="section" data-type="immune"></div>',
        '<div class="section" data-type="overcast"></div>',
        '<div class="section" data-type="dry"></div>',
        '<div class="section" data-type="ice"></div>',
        '<div class="section" data-type="para"></div>',
        '<div class="section" data-type="coop"></div>',
      ].join('');
      return card;
    }

    function updateLeaderboard(){
      const board = document.getElementById('leaderboard');
      const container = document.getElementById('players-container');
      if(!board || !container) return;
      const cards = Array.from(container.querySelectorAll('.player'));
      if(cards.length===0){
        board.innerHTML = '<div class="lb-head">'+
          '<div class="lb-title"><h3>🏆 Leaderboard</h3></div>'+
          '<div class="toggle-wrap"><span>WTDGAP Expansion Pack</span><button id="expansion-toggle" class="toggle-btn '+(expansionOn?'on">ON':'off">OFF')+'</button></div>'+
          '</div><div>No players</div>';
        bindExpansionToggle();
        return;
      }
      const players = cards.map((card,i)=>{
        const name = (card.querySelector('input.player-name')?.value || ('Player '+(i+1))).trim();
        const avatar = (card.querySelector('.avatar')?.textContent || '👤').trim();
        const atp = parseInt(card.querySelector('input.atp')?.value) || 0;
        const glu = parseInt(card.querySelector('input.glu')?.value) || 0;
        const bg = (card.style.background && card.style.background.trim()) || '#ffffff';
        return {name, avatar, atp, glu, bg};
      }).sort((a,b)=> b.atp-a.atp || b.glu-a.glu);
      const champ = players[0];

      function chipStyles(bg){ return 'style="background:'+bg+';"'; }

      board.innerHTML =
        '<div class="lb-head">'+
          '<div class="lb-title"><h3>🏆 Leaderboard</h3></div>'+
          '<div class="toggle-wrap"><span>WTDGAP Expansion Pack</span><button id="expansion-toggle" class="toggle-btn '+(expansionOn?'on">ON':'off">OFF')+'</button></div>'+
        '</div>' +
        // Champion section: NO rank pill, bigger name chip, stats on right
        '<div class="champ-row">'+
          '<div class="champ-left">'+
            '<span class="chip-btn big" '+chipStyles(champ.bg)+' title="Champion">'+champ.avatar+' <b class="name-text">'+champ.name+'</b></span>'+
          '</div>'+
          '<div class="champ-right">⚡ '+champ.atp+' &nbsp; | &nbsp; 🍞 '+champ.glu+'</div>'+
        '</div>'+
        '<hr class="lb-divider" />' +
        // List
        players.map((p,i)=>
          '<div class="row">'+
            '<div class="namecell">'+
              '<span class="pill-btn" '+chipStyles(p.bg)+' title="Rank '+(i+1)+'">'+(i+1)+'</span> '+
              '<span class="chip-btn" '+chipStyles(p.bg)+' title="Player">'+p.avatar+' <b class="name-text">'+p.name+'</b></span>'+
            '</div>'+
            '<div style="text-align:right;">ATP '+String(p.atp).padStart(3)+' | Glu '+String(p.glu).padStart(3)+'</div>'+
            '<div>🏅</div>'+
          '</div>'
        ).join('');

      bindExpansionToggle();
    }

    function bindExpansionToggle(){
      const btn = document.getElementById('expansion-toggle');
      if(!btn) return;
      btn.addEventListener('click', ()=>{
        expansionOn = !expansionOn;
        applyExpansionVisibility();
        updateLeaderboard();
      });
    }

    function updateAddPlayerButton(){
      const container = document.getElementById('players-container');
      const btn = document.getElementById('add-player-btn');
      if(!container || !btn) return;
      const count = container.querySelectorAll('.player').length;
      if(count>=6){ btn.disabled=true; btn.textContent='Player cap reached (6)'; }
      else { btn.disabled=false; btn.textContent='➕ Add Player'; }
    }

    function resetGame(){
      const turn = document.getElementById('turn'); if(turn) turn.value = 1;
      const day = document.getElementById('daynight'); if(day) day.textContent = '🌞 Day';
      isDay = true;
      const container = document.getElementById('players-container');
      if(container){
        const cards = Array.from(container.querySelectorAll('.player'));
        cards.forEach((card,i)=>{
          const atp = card.querySelector('input.atp'); if(atp) atp.value = 20;
          const glu = card.querySelector('input.glu'); if(glu) glu.value = 0;
          card.querySelectorAll('.section').forEach(sec=> sec.innerHTML='');
          const name = card.querySelector('input.player-name');
          if(name && /^Player\s*\d*$/.test((name.value||'').trim())) name.value = 'Player ' + (i+1);
          /* keep player card background color (do not reset) */
        });
      }
      reindex();
    }

    document.getElementById('add-player-btn')?.addEventListener('click', addPlayer);
    document.getElementById('reset-btn')?.addEventListener('click', resetGame);
    document.getElementById('switch-btn')?.addEventListener('click', function(){
      isDay = !isDay;
      const day = document.getElementById('daynight');
      if(day) day.textContent = isDay ? '🌞 Day' : '🌙 Night';
    });
    document.getElementById('next-btn')?.addEventListener('click', function(){
      const turn = document.getElementById('turn');
      if(turn) turn.value = (parseInt(turn.value)||1) + 1;
      const day = document.getElementById('daynight');
      if(day) day.textContent = isDay ? '🌙 Night' : '🌞 Day';
      isDay = !isDay;
      const audio = document.getElementById('click-sound'); if(audio){ audio.currentTime=0; audio.play(); }
    });

    const firstCard = document.querySelector('#players-container .player');
    if(firstCard) { bindPlayerCard(firstCard); }
    reindex();
    updateAddPlayerButton();
    applyExpansionVisibility();
    updateLeaderboard();
    setInterval(updateLeaderboard, 800);

    document.getElementById('confirm-no')?.addEventListener('click', closeConfirm);
    document.getElementById('confirm-yes')?.addEventListener('click', function(){
      if(confirmTarget && confirmTarget.parentElement) confirmTarget.parentElement.removeChild(confirmTarget);
      closeConfirm();
      reindex();
    });
  })();
  </script>

<script>
(function(){
  function isInteractive(node){
    return !!(node && (
      node.closest('button, input, select, textarea, a, .icon-btn, .pm, .paint-btn, .toolbar, .reorder, .value-input')
    ));
  }

  function enableLongPressDrag(container){
    let dragging = null, placeholder = null;
    let startY = 0, startTop = 0, startRect = null;
    let pressTimer = null, holdMs = 2000;
    let downScrollY = 0, startClientY = 0;
    const moveThreshold = 6; // px

    function startDrag(card){
      const scrollY = window.scrollY || window.pageYOffset;
      startRect = card.getBoundingClientRect();
      placeholder = document.createElement('div');
      placeholder.className = 'player placeholder';
      placeholder.style.setProperty('--ph', startRect.height+'px');
      container.insertBefore(placeholder, card.nextSibling);

      card.classList.remove('hold-hint');
      card.classList.add('dragging');
      card.style.left = (startRect.left)+'px';
      card.style.top  = (startRect.top + scrollY)+'px';
      card.style.pointerEvents = 'none';

      dragging = card;
      startY = startClientY + scrollY;
      startTop = startRect.top + scrollY;

      document.addEventListener('pointermove', onPointerMove);
      document.addEventListener('pointerup', onPointerUp, { once: true });
    }

    function clearTimer(card){
      if(pressTimer){ clearTimeout(pressTimer); pressTimer = null; }
      if(card){ card.classList.remove('hold-hint'); }
    }

    function onPointerDown(e){
      const card = e.target.closest('.player');
      if(!card || !container.contains(card)) return;
      // 仅空白区域触发：跳过交互控件
      if(isInteractive(e.target)) return;

      startClientY = e.clientY;
      downScrollY = (window.scrollY || window.pageYOffset);

      // 给出长按提示
      card.classList.add('hold-hint');

      pressTimer = setTimeout(function(){
        // 静止检测：滚动或移动超过阈值则取消
        const moved = Math.abs((window.scrollY||window.pageYOffset) - downScrollY) > moveThreshold;
        if(!moved){
          startDrag(card);
          e.preventDefault();
        } else {
          clearTimer(card);
        }
      }, holdMs);

      // 监听移动，若移动过大则取消长按
      function cancelOnMove(ev){
        const dy = Math.abs(ev.clientY - startClientY);
        if(dy > moveThreshold){
          clearTimer(card);
          container.removeEventListener('pointermove', cancelOnMove);
          container.removeEventListener('pointerup', cancelHold);
        }
      }
      function cancelHold(){
        clearTimer(card);
        container.removeEventListener('pointermove', cancelOnMove);
        container.removeEventListener('pointerup', cancelHold);
      }
      container.addEventListener('pointermove', cancelOnMove);
      container.addEventListener('pointerup', cancelHold, { once: true });
    }

    function onPointerMove(e){
      if(!dragging) return;
      const scrollY = window.scrollY || window.pageYOffset;
      const y = e.clientY + scrollY;
      const dy = y - startY;
      dragging.style.top = (startTop + dy) + 'px';

      const cards = Array.from(container.querySelectorAll('.player')).filter(el=>el!==dragging && el!==placeholder);
      for(const el of cards){
        const r = el.getBoundingClientRect();
        const center = r.top + scrollY + r.height/2;
        if(y < center){
          container.insertBefore(placeholder, el);
          return;
        }
      }
      container.appendChild(placeholder);
    }

    function onPointerUp(){
      // 完成拖动
      if(dragging){
        container.insertBefore(dragging, placeholder);
        dragging.classList.remove('dragging');
        dragging.style.pointerEvents = '';
        dragging.style.left = '';
        dragging.style.top = '';
        dragging = null;
        if(placeholder && placeholder.parentNode){ placeholder.parentNode.removeChild(placeholder); }
        placeholder = null;
        if(typeof reindex === 'function') reindex();
        if(typeof updateLeaderboard === 'function') updateLeaderboard();
      }
      // 清理计时器/事件
      clearTimer();
      document.removeEventListener('pointermove', onPointerMove);
      document.removeEventListener('pointerup', onPointerUp);
    }

    container.addEventListener('pointerdown', onPointerDown);
  }

  document.addEventListener('DOMContentLoaded', function(){
    const container = document.getElementById('players-container');
    if(container) enableLongPressDrag(container);
  });
})();
</script>


<script>
(function(){
  function isInteractive(node){
    return !!(node && (
      node.closest('button, input, select, textarea, a, .icon-btn, .pm, .paint-btn, .toolbar, .reorder, .value-input')
    ));
  }

  function enableLongPressDrag(container){
    let dragging = null, placeholder = null;
    let startY = 0, startTop = 0, startRect = null;
    let pressTimer = null, holdMs = 1500; // ⏱ 1.5s
    let downScrollY = 0, startClientY = 0;
    const moveThreshold = 15; // px

    function showTip(card){
      removeTip(card);
      const tip = document.createElement('div');
      tip.className = 'hold-tip';
      tip.textContent = 'Hold to drag…';
      card.appendChild(tip);
      return tip;
    }
    function removeTip(card){
      if(!card) return;
      const t = card.querySelector('.hold-tip');
      if(t && t.parentNode) t.parentNode.removeChild(t);
    }

    function startDrag(card){
      const scrollY = window.scrollY || window.pageYOffset;
      startRect = card.getBoundingClientRect();
      placeholder = document.createElement('div');
      placeholder.className = 'player placeholder';
      placeholder.style.setProperty('--ph', startRect.height+'px');
      container.insertBefore(placeholder, card.nextSibling);

      card.classList.remove('hold-hint');
      removeTip(card);
      card.classList.add('dragging');
      card.style.left = (startRect.left)+'px';
      card.style.top  = (startRect.top + scrollY)+'px';
      card.style.pointerEvents = 'none';

      dragging = card;
      startY = startClientY + scrollY;
      startTop = startRect.top + scrollY;

      document.addEventListener('pointermove', onPointerMove);
      document.addEventListener('pointerup', onPointerUp, { once: true });
    }

    function clearTimer(card){
      if(pressTimer){ clearTimeout(pressTimer); pressTimer = null; }
      if(card){ card.classList.remove('hold-hint'); removeTip(card); }
    }

    function onPointerDown(e){
      const card = e.target.closest('.player');
      if(!card || !container.contains(card)) return;
      if(isInteractive(e.target)) return; // 点击到控件，放行

      startClientY = e.clientY;
      downScrollY = (window.scrollY || window.pageYOffset);

      // 给出长按提示
      card.classList.add('hold-hint');
      showTip(card);

      pressTimer = setTimeout(function(){
        // 静止检测：垂直移动或滚动超过阈值则取消
        const moved = Math.abs((window.scrollY||window.pageYOffset) - downScrollY) > moveThreshold;
        if(!moved){
          startDrag(card);
          e.preventDefault();
        } else {
          clearTimer(card);
        }
      }, holdMs);

      // 监听移动/松手，满足条件则取消长按
      function cancelOnMove(ev){
        const dy = Math.abs(ev.clientY - startClientY);
        if(dy > moveThreshold){
          clearTimer(card);
          container.removeEventListener('pointermove', cancelOnMove);
          container.removeEventListener('pointerup', cancelHold);
        }
      }
      function cancelHold(){
        clearTimer(card);
        container.removeEventListener('pointermove', cancelOnMove);
        container.removeEventListener('pointerup', cancelHold);
      }
      container.addEventListener('pointermove', cancelOnMove);
      container.addEventListener('pointerup', cancelHold, { once: true });
    }

    function onPointerMove(e){
      if(!dragging) return;
      const scrollY = window.scrollY || window.pageYOffset;
      const y = e.clientY + scrollY;
      const dy = y - startY;
      dragging.style.top = (startTop + dy) + 'px';

      const cards = Array.from(container.querySelectorAll('.player')).filter(el=>el!==dragging && el!==placeholder);
      for(const el of cards){
        const r = el.getBoundingClientRect();
        const center = r.top + scrollY + r.height/2;
        if(y < center){
          container.insertBefore(placeholder, el);
          return;
        }
      }
      container.appendChild(placeholder);
    }

    function onPointerUp(){
      if(dragging){
        container.insertBefore(dragging, placeholder);
        dragging.classList.remove('dragging');
        dragging.style.pointerEvents = '';
        dragging.style.left = '';
        dragging.style.top = '';
        dragging = null;
        if(placeholder && placeholder.parentNode){ placeholder.parentNode.removeChild(placeholder); }
        placeholder = null;
        if(typeof reindex === 'function') reindex();
        if(typeof updateLeaderboard === 'function') updateLeaderboard();
      }
      document.removeEventListener('pointermove', onPointerMove);
      document.removeEventListener('pointerup', onPointerUp);
    }

    container.addEventListener('pointerdown', onPointerDown);
  }

  document.addEventListener('DOMContentLoaded', function(){
    const container = document.getElementById('players-container');
    if(container) enableLongPressDrag(container);
  });
})();
</script>

</body>
</html>
