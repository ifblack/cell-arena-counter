<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Cell Arena ATP Counter (Dynamic Players v3.4)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  :root {
    --accent: #1976d2;
    --border: #d8dee9;
    --text: #1f2937;
    --shadow: 0 2px 6px rgba(0,0,0,0.06);
    --on: #2e7d32;
    --off: #b00020;
  }
  * { box-sizing: border-box; }
  body { font-family: "Segoe UI", "PingFang SC", "Microsoft Yahei", sans-serif; margin:0; background:#f8fbff; color:var(--text); }
  h1 { text-align:center; color:#1a2c43; margin:16px 0; }

  .topbar { background:#f0f0f0; padding:10px; text-align:center; }
  .topbar a { margin:0 10px; font-size:14px; color:#333; text-decoration:none; }

  .wrapper { width:100%; display:flex; flex-direction:column; align-items:center; padding:10px; }

  .panel, .player {
    width: clamp(300px, 92vw, 420px);
    margin:14px auto;
    background:#fff;
    border:2px solid var(--border);
    border-radius:12px;
    box-shadow:var(--shadow);
    padding:12px;
  }
  #leaderboard { background:#e3f2fd; }

  .lb-head {
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    margin-bottom:6px;
  }
  .lb-title { display:flex; align-items:center; gap:8px; }
  .lb-title h3 { margin:0; display:flex; align-items:center; gap:8px; }
  .toggle-wrap { display:flex; align-items:center; gap:3px; font-weight:600; }
  .toggle-wrap span { font-size:0.78em; opacity:0.9; }
  .toggle-btn {
    min-width:40px; height:24px; padding:0 8px; border:none; border-radius:14px; color:#fff; cursor:pointer;
    box-shadow:0 1px 3px rgba(0,0,0,0.15); font-weight:700; font-size:0.85em;
  }
  .toggle-btn.on  { background:var(--on); }
  .toggle-btn.off { background:var(--off); }

  /* Buttons / chips (colors sync with player card bg) */
  .pill-btn {
    display:inline-flex; align-items:center; justify-content:center;
    min-width:26px; height:24px; padding:0 10px;
    border:1px solid #c3dafe; border-radius:999px; background:#ffffff; color:#1e3a8a;
    font-weight:700; box-shadow:0 1px 3px rgba(0,0,0,0.15); font-size:0.9em; flex:0 0 auto;
  }
  .chip-btn {
    display:inline-flex; align-items:center; gap:6px;
    height:24px; padding:0 10px;
    border:1px solid #c3dafe; border-radius:999px; background:#ffffff; color:#1e3a8a;
    font-weight:700; box-shadow:0 1px 3px rgba(0,0,0,0.15); font-size:0.9em; flex:1 1 auto;
    min-width:0;
  }
  .chip-btn.big {
    height:32px; padding:0 14px; font-size:1rem; /* bigger for champion */
  }
  .name-text {
    display:inline-block; max-width:100%;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  /* Champion row layout */
  #leaderboard .champ-row {
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    margin:6px 0 8px 0;
  }
  #leaderboard .champ-left { display:flex; align-items:center; gap:8px; min-width:0; flex:1 1 auto; }
  #leaderboard .champ-right {
    text-align:right; font-size:1.05rem; font-weight:700; flex:0 0 auto;
  }
  .lb-divider {
    border:0; border-top:2px dashed rgba(0,0,0,0.08); margin:8px 0 6px 0;
  }

  /* Leader rows: first column 210px (rank + name) */
  #leaderboard .row {
    display:grid; grid-template-columns: 210px 1fr 24px; align-items:center;
    margin:2px 0; font-family:monospace; font-size:0.95rem;
  }
  #leaderboard .row .namecell {
    padding:2px 6px; border-radius:6px; display:flex; align-items:center; gap:6px;
    min-width:0; background:transparent !important;
  }

  .player-header { display:flex; align-items:center; justify-content:space-between; gap:6px; }
  .player-title { display:flex; align-items:center; gap:8px; }
  .avatar { margin:0; cursor:pointer; user-select:none; }
  .player-title input.player-name { font-size:1em; padding:2px 8px; border-radius:6px; border:1px solid #bbb; width:160px; }

  .reorder { display:flex; gap:6px; flex-wrap:wrap; }
  .icon-mini {
    width:32px; height:32px; font-size:0.95rem; padding:0; margin:0;
    border:none; border-radius:8px; background:#ffffff; color:#333;
    box-shadow:0 2px 6px rgba(0,0,0,0.15); cursor:pointer; transition:all .2s;
  }
  .icon-mini:hover { background:#e0f0ff; transform:scale(1.05); }

  .counter { display:flex; align-items:center; margin:8px 0; gap:8px; }
  .label { font-weight:bold; width:120px; }
  .pm {
    min-width:32px; height:28px; padding:0 6px;
    border:1px solid #cbd5e1; border-radius:8px; background:#fff; color:#111;
    box-shadow:0 2px 4px rgba(0,0,0,0.08);
    font-size:0.95rem; line-height:26px; cursor:pointer;
  }
  .pm:hover { background:#eef6ff; }
  .value-input { font-size:1rem; width:64px; text-align:center; padding:3px 6px; border-radius:6px; border:1px solid #ccc; }

  .toolbar {
    display:grid;
    grid-template-columns: repeat(5, 1fr);
    gap:8px;
    margin-top:8px;
  }
  .icon-btn {
    font-size:20px; width:100%; height:40px; display:flex; align-items:center; justify-content:center;
    padding:0; border:none; border-radius:8px; background:#ffffff; color:#333;
    box-shadow:0 2px 6px rgba(0,0,0,0.15); transition:all .2s; cursor:pointer;
  }
  .icon-btn:hover { background:#d0ebff; transform:scale(1.02); }
  .hidden { display:none !important; }

  .section { margin:6px 0; }
  .section .counter .remove-btn {
    width:28px; height:28px; font-size:1rem; padding:0;
    border:1px solid #f1aeb5; border-radius:8px; background:#fff; color:#b02a37;
    box-shadow:0 2px 4px rgba(0,0,0,0.08); cursor:pointer;
  }
  .section .counter .remove-btn:hover { background:#ffe2e5; }

  .controls { text-align:center; margin-bottom:12px; }
  .controls .value-input { width:64px; }

  .circle {
    background: linear-gradient(to bottom, #28a745, #218838);
    border: none; color: white; font-size: 1.05em;
    width: 56px; height: 56px; border-radius: 50%;
    box-shadow: 0 4px #1c7430; cursor:pointer;
  }
  .primary {
    font-size:0.95em; padding:8px 14px; border:none; border-radius:10px;
    background:var(--accent); color:#fff; cursor:pointer;
  }
  .primary:active { filter:brightness(0.92); }
  .btn-danger { background:#dc3545; color:white; font-size:0.95em; padding:8px 14px; border-radius:10px; border:none; box-shadow:0 4px #a71d2a; cursor:pointer; }

  .footer { height:90px; background:#f0f0f0; margin-top:10px; display:flex; flex-direction:column; justify-content:center; align-items:center; }

  .modal-mask { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:1000; }
  .modal { background:#fff; padding:16px; border-radius:12px; width:90%; max-width:360px; box-shadow:var(--shadow); }
  .modal h4 { margin:0 0 12px 0; }
  .modal .actions { display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }
  .btn-ghost { background:#f5f5f5; color:#333; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; }

/* === Long-press drag to reorder === */
.player.dragging {
  position: absolute !important;
  width: 420px;
  transform: scale(1.01);
  box-shadow: 0 14px 30px rgba(16,24,40,.28) !important;
  cursor: grabbing !important;
  z-index: 1000;
}
.player.placeholder {
  border: 2px dashed #a7c5eb;
  background: transparent !important;
  height: var(--ph, 140px);
  border-radius: 12px;
  margin: 14px auto;
}
.player.hold-hint {
  animation: holdPulse 1s ease-in-out infinite;
}
@keyframes holdPulse {
  0%   { box-shadow: 0 0 0 0 rgba(25,118,210,0.0); }
  50%  { box-shadow: 0 0 0 6px rgba(25,118,210,0.18); }
  100% { box-shadow: 0 0 0 0 rgba(25,118,210,0.0); }
}

.player { position: relative; }
.player .hold-tip {
  position: absolute;
  left: 50%;
  top: -10px;
  transform: translate(-50%, -100%);
  padding: 6px 10px;
  background: rgba(17, 24, 39, 0.92);
  color: #fff;
  border-radius: 8px;
  font-size: 12px;
  white-space: nowrap;
  box-shadow: 0 2px 8px rgba(0,0,0,.25);
  pointer-events: none;
  opacity: 0;
  animation: tipFade .18s ease forwards;
  z-index: 5;
}
.player .hold-tip::after {
  content: "";
  position: absolute;
  bottom: -6px;
  left: 50%;
  transform: translateX(-50%);
  border-width: 6px 6px 0 6px;
  border-style: solid;
  border-color: rgba(17,24,39,0.92) transparent transparent transparent;
}
@keyframes tipFade {
  from { opacity: 0; transform: translate(-50%, -110%); }
  to   { opacity: 1; transform: translate(-50%, -100%); }
}

/* === Glass Buttons === */
.glass-btn{position:relative;display:inline-flex;align-items:center;justify-content:center;gap:.4rem;padding:10px 16px;border-radius:14px;font-weight:700;letter-spacing:.2px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.10);color:#fff;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);box-shadow:inset 1px 1px 3px rgba(255,255,255,.18),inset -1px -1px 3px rgba(0,0,0,.18),0 4px 12px rgba(0,0,0,.22);cursor:pointer;transition:transform .2s ease,box-shadow .3s ease,background .3s ease,border-color .3s ease;}
.glass-btn.green{background:radial-gradient(140% 140% at 30% 20%,rgba(60,190,110,.85) 0%,rgba(30,150,70,.85) 60%,rgba(18,92,42,.9) 100%);border-color:rgba(30,150,70,.45);box-shadow:0 0 0 2px rgba(80,230,140,.25) inset,0 8px 20px rgba(18,92,42,.45),0 2px 12px rgba(0,0,0,.18)}
.glass-btn.green:hover{background:radial-gradient(140% 140% at 30% 20%,rgba(60,200,115,.92) 0%,rgba(30,160,75,.92) 60%,rgba(18,92,42,.95) 100%);box-shadow:0 0 0 3px rgba(80,230,140,.32) inset,0 12px 28px rgba(18,92,42,.55),0 4px 16px rgba(0,0,0,.22);transform:translateY(-1px)}
.glass-btn.red{background:radial-gradient(140% 140% at 30% 20%,rgba(255,120,132,.95) 0%,rgba(220,53,69,.92) 60%,rgba(140,0,24,.96) 100%);border-color:rgba(176,0,32,.5);box-shadow:0 0 0 2px rgba(255,120,132,.35) inset,0 10px 24px rgba(176,0,32,.45),0 4px 14px rgba(0,0,0,.18)}
.glass-btn.red:hover{box-shadow:0 0 0 4px rgba(255,120,132,.45) inset,0 16px 36px rgba(176,0,32,.55),0 6px 20px rgba(0,0,0,.26);transform:translateY(-1px)}
.glass-btn.circle{width:78px;height:78px;border-radius:50%;font-size:1.05rem;font-weight:800;line-height:1;padding:0}
.glass-btn.circle.green:hover{animation:breathe 1.6s ease-in-out infinite}
@keyframes breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
.center-row{display:flex;justify-content:center;align-items:center;gap:10px; margin-top: 24px; }

/* === Fixed width buttons for Add Player / Restart Game === */
.cta {
  width: 160px;
  height: 48px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 0.95rem;
}

</style>

<style>
/* Compact leaderboard for small screens (≤400px) to keep one-line layout at 375px */
@media (max-width: 400px) {
  #leaderboard .lb-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 6px;
    white-space: nowrap;
    flex-wrap: nowrap;
    padding: 2px 4px;
  }
  #leaderboard .lb-head .lb-title h3 {
    font-size: 14px;
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #leaderboard .lb-head .toggle-wrap {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    flex: 0 0 auto;
    white-space: nowrap;
  }
  #leaderboard .row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 6px;
    white-space: nowrap;
    padding: 2px 4px;
  }
  #leaderboard .row .namecell {
    flex: 1 1 auto;
    min-width: 0;
    overflow: hidden;
  }
  #leaderboard .row .name-text {
    display: inline-block;
    max-width: 68vw; /* leave width for stats at 375px */
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: bottom;
  }
  #leaderboard .row .stats {
    flex: 0 0 auto;
    text-align: right;
    font-size: 12px;
    line-height: 1;
    max-width: 34vw;
    white-space: nowrap;
  }
  .pill-btn { padding: 0 8px; min-width: 24px; height: 22px; font-size: 0.8rem; }
  .chip-btn { padding: 0 8px; height: 22px; font-size: 0.85rem; gap: 4px; }
  .chip-btn.big { height: 28px; padding: 0 10px; font-size: 0.95rem; }
}
</style>


<style>
/* Prevent page stuck after drag: lock only during drag */
html.scroll-locked, body.scroll-locked { overflow: hidden !important; touch-action: none; overscroll-behavior: contain; }
</style>

<style>.player.dragging{position:absolute !important;width:min(92vw, 420px) !important;transform:scale(1.01);box-shadow:0 14px 30px rgba(16,24,40,.28) !important;cursor:grabbing !important;z-index:1000;touch-action:none !important;}</style><style>.scroll-locked{overflow:hidden!important;touch-action:none!important;}</style><style>.player, .player *{-webkit-user-select:none;user-select:none}.player.dragging{-webkit-touch-callout:none}</style><style>@media (max-width: 400px){#leaderboard .row{display:flex;align-items:center;justify-content:space-between;gap:6px;white-space:nowrap;padding:2px 4px;}#leaderboard .row .namecell{flex:1 1 auto;min-width:0;overflow:hidden;}#leaderboard .row .name-text{display:inline-block;max-width:64vw;overflow:hidden;text-overflow:ellipsis;vertical-align:bottom;}#leaderboard .row .stats{flex:0 0 auto;text-align:right;font-size:12px;line-height:1;max-width:32vw;white-space:nowrap;}#leaderboard .row>:last-child{flex:0 0 auto;}.icon-mini.drag-handle{cursor:grab;touch-action:none;}.icon-mini.drag-handle:active{cursor:grabbing;}}</style>
<script>
(function(){
  document.documentElement.classList.remove('scroll-locked');
  document.body.classList.remove('scroll-locked');
})();
</script>

</head>

<body style="max-width: 1250px; margin: 0 auto;">
  <!-- 顶部导航区域 -->
<div style="background:#f0f0f0; padding: 10px; text-align:center;">
  <a href="https://mp.weixin.qq.com/s/echWb-6CIUU1hnVUyQiF0A" target="_blank"
     style="margin: 0 10px; font-size:14px; color:#333; text-decoration:none;">📄 Manual</a>
  <a href="https://mp.weixin.qq.com/s/4R_AuXsxTG752rNBpNUALQ" target="_blank"
     style="margin: 0 10px; font-size:14px; color:#333; text-decoration:none;">📜 Rules</a>
  <a href="https://mp.weixin.qq.com/s/6rHPx3pbmoM_bQaaHwhe7A" target="_blank"
     style="margin: 0 10px; font-size:14px; color:#333; text-decoration:none;">🧭 Guide</a>
  <a href="https://mp.weixin.qq.com/s/FKWpYsSEOCHACpNHa_Zgwg" target="_blank"
     style="margin: 0 10px; font-size:14px; color:#333; text-decoration:none;">ℹ️ About</a>
</div>
  <h1>🧪 Cell Arena ATP Counter</h1>

  <div class="controls">
    <span id="label-turn" style="font-weight:bold;">Turn</span>
    <button class="pm" onclick="(function(){var el=document.getElementById('turn'); el.value=Math.max(1,(parseInt(el.value)||1)-1);})()">−</button>
    <input class="value-input" id="turn" max="999" min="1" type="number" value="1"/>
    <button class="pm" onclick="(function(){var el=document.getElementById('turn'); el.value=(parseInt(el.value)||1)+1;})()">+</button>
    <span id="daynight" style="font-weight:bold; margin-left:16px;">🌞 Day</span>
    <button id="switch-btn" style="margin-left: 8px;">Switch</button>
  </div>

  
<div class="center-row"><button class="circle glass-btn circle green" id="next-btn">Next</button></div>


  <div class="wrapper">
    <div id="leaderboard" class="panel">
      <div class="lb-head">
        <div class="lb-title"><h3>🏆 Leaderboard</h3></div>
        <div class="toggle-wrap">
          <span>WTDGAP Expansion Pack</span>
          <button id="expansion-toggle" class="toggle-btn on">ON</button>
        </div>
      </div>
      <div>Loading…</div>
    </div>

    <div id="players-container">
      <div class="player" data-player="1">
        <div class="player-header">
          <div class="player-title">
            <h2 class="avatar" title="Click to change avatar">👤</h2>
            <input class="player-name" value="Player 1" />
          </div>
          <div class="reorder"><button class="icon-mini drag-handle" title="按住上下拖动排序">↕️</button>
            <button class="icon-mini paint-btn" title="Click: random color • Long press: reset to white">🎨</button>
            <button class="icon-mini" title="Delete player">🗑️</button>
          </div>
        </div>

        <div class="counter" data-core="1">
          <span class="label">⚡ ATP</span>
          <button class="pm">−</button>
          <input class="value-input atp" max="999" min="0" type="number" value="20"/>
          <button class="pm">+</button>
        </div>
        <div class="counter" data-core="1">
          <span class="label">🍞 Glucose</span>
          <button class="pm">−</button>
          <input class="value-input glu" max="999" min="0" type="number" value="0"/>
          <button class="pm">+</button>
        </div>

        <div class="toolbar">
          <button class="icon-btn">🧬</button>
          <button class="icon-btn">🔬</button>
          <button class="icon-btn exp-core">🦠</button>
          <button class="icon-btn exp-core">☣️</button>
          <button class="icon-btn exp-core">🛡️</button>
          <button class="icon-btn expansion">☁️</button>
          <button class="icon-btn expansion">🔥</button>
          <button class="icon-btn expansion">🧊</button>
          <button class="icon-btn expansion">👾</button>
          <button class="icon-btn expansion">🤝</button>
        </div>

        <div class="section" data-type="mito"></div>
        <div class="section" data-type="cell"></div>
        <div class="section" data-type="infectA"></div>
        <div class="section" data-type="infectB"></div>
        <div class="section" data-type="immune"></div>
        <div class="section" data-type="overcast"></div>
        <div class="section" data-type="dry"></div>
        <div class="section" data-type="ice"></div>
        <div class="section" data-type="para"></div>
        <div class="section" data-type="coop"></div>
      </div>
    </div>

    <div style="text-align:center; margin-top:8px;">
      <button id="add-player-btn" class="primary glass-btn green cta">➕ Add Player</button>
    </div>
  </div>

  <div style="text-align:center; margin: 18px;">
    <button id="reset-btn" class="btn-danger glass-btn red cta">🔁 Restart Cou.</button>
  </div>

  <div id="confirm-mask" class="modal-mask" role="dialog" aria-modal="true">
    <div class="modal">
      <h4>Delete Player</h4>
      <div>Are you sure you want to delete this player? This action cannot be undone.</div>
      <div class="actions">
        <button id="confirm-no" class="btn-ghost">Cancel</button>
        <button id="confirm-yes" class="btn-danger">Confirm Delete</button>
      </div>
    </div>
  </div>

  <audio id="click-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_b0b2e878c7.mp3"></audio>

  <div class="footer">
    <p style="font-size:14px; font-weight:bold; color:#555; margin:0;">SciArena LLC Team</p>
   <div style="margin-top: 4px;">
    <a href="https://channels.weixin.qq.com/shop/b/XxrPiGCgstFRpyf" target="_blank"
   style="margin: 0 10px; font-size:14px; color:#333; text-decoration:none;">🛍️ store</a>
    <a href="mailto:sciarena.team@gmail.com"
      style="margin: 0 10px; font-size:14px; color:#333; text-decoration:none;">📧 Email</a>
    <a href="https://www.sciarenalabs.com/" target="_blank"
      style="margin: 0 10px; font-size:14px; color:#333; text-decoration:none;">🌐 Website</a>
  </div>

  <script>
  // Global variables
  window.isDay = true;
  window.confirmTarget = null;
  window.expansionOn = true;

  const avatarList = ['👤','🐱','🐶','🐼','🦊','🐻','🦆','🐯','🐵','🐰','🐮','🐨','🧙','⚔️','🛡️'];

  // Utility functions
  function rnd(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function randomPastel(){ const h=rnd(0,360), s=rnd(45,65), l=rnd(88,95); return `hsl(${h} ${s}% ${l}%)`; }

  function playSound() {
    const audio = document.getElementById('click-sound');
    if(audio){ 
      audio.currentTime = 0;
      audio.play().catch(e => console.log('Audio play failed:', e));
    }
  }

  function nextTurn() {
    const turn = document.getElementById('turn');
    if(turn) turn.value = (parseInt(turn.value)||1) + 1;
    const day = document.getElementById('daynight');
    if(day) day.textContent = window.isDay ? '🌙 Night' : '🌞 Day';
    window.isDay = !window.isDay;
  }

  function changeAdjacentInput(btn, delta, max=2048){
    const row = btn.closest('.counter');
    const input = row ? row.querySelector('input.value-input') : null;
    if(!input) return;
    let v = parseInt(input.value); v = isNaN(v) ? 0 : v;
    input.value = Math.max(0, Math.min(max, v+delta));
  }

  function bindAvatar(card){
    const avatar = card.querySelector('.avatar');
    if(!avatar) return;
    avatar.addEventListener('click', ()=>{
      const curr = avatar.textContent;
      const idx = avatarList.indexOf(curr);
      const next = avatarList[(idx+1+avatarList.length)%avatarList.length];
      avatar.textContent = next;
    });
  }

  function bindPaintButton(card){
    const paintBtn = card.querySelector('.paint-btn');
    if(!paintBtn) return;
    let pressTimer = null, longPressed = false;
    function clearTimer(){ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } }
    paintBtn.addEventListener('mousedown', ()=>{
      longPressed=false; pressTimer=setTimeout(()=>{ longPressed=true; card.style.background='#ffffff'; },600);
    });
    paintBtn.addEventListener('mouseup', ()=>{ if(!longPressed){ card.style.background = randomPastel(); } clearTimer(); });
    paintBtn.addEventListener('mouseleave', clearTimer);
    paintBtn.addEventListener('touchstart', ()=>{
      longPressed=false; pressTimer=setTimeout(()=>{ longPressed=true; card.style.background='#ffffff'; },600);
    }, {passive:true});
    paintBtn.addEventListener('touchend', ()=>{ if(!longPressed){ card.style.background = randomPastel(); } clearTimer(); });
    paintBtn.addEventListener('touchcancel', clearTimer);
  }

  function toolbarButton(label, emoji, sectionType, def, classes) {
    const b = document.createElement('button');
    b.className = 'icon-btn ' + (classes || '');
    b.textContent = emoji;
    b.title = label;
    b.addEventListener('click', function(){
      const card = b.closest('.player');
      const section = card && card.querySelector('.section[data-type="'+sectionType+'"]');
      if(!section) return;
      const existingRows = section.querySelectorAll('.counter').length;
      if(existingRows >= 3) return;
      const div = document.createElement('div');
      div.className = 'counter';
      const labelHtml = '<span class="label">'+(sectionType==='coop' ? '🤝 Cooperation' : (emoji+' '+label))+'</span>';
      div.innerHTML = labelHtml +
                      '<button class="pm minus">−</button>' +
                      '<input type="number" min="0" max="2048" value="'+def+'" class="value-input">' +
                      '<button class="pm plus">+</button>' +
                      '<button class="remove-btn" title="Delete">⌫</button>';
      section.appendChild(div);
      const minus = div.querySelector('button.minus');
      const plus  = div.querySelector('button.plus');
      const removeBtn = div.querySelector('button.remove-btn');
      minus.addEventListener('click', ()=>changeAdjacentInput(minus,-1,2048));
      plus.addEventListener('click', ()=>changeAdjacentInput(plus,1,2048));
      removeBtn.addEventListener('click', ()=>div.remove());
    });
    return b;
  }

  function applyExpansionVisibility(){
    const expBtns = document.querySelectorAll('.toolbar .expansion, .toolbar .exp-core');
    expBtns.forEach(btn => {
      if(window.expansionOn) btn.classList.remove('hidden');
      else btn.classList.add('hidden');
    });
    const toggle = document.getElementById('expansion-toggle');
    if(toggle){
      toggle.textContent = window.expansionOn ? 'ON' : 'OFF';
      toggle.classList.toggle('on', window.expansionOn);
      toggle.classList.toggle('off', !window.expansionOn);
    }
  }

  function bindPlayerCard(card){
    const delBtn = card.querySelector('.reorder .icon-mini[title="Delete player"]');
    const paintBtn = card.querySelector('.reorder .paint-btn');

    if(delBtn) delBtn.addEventListener('click', ()=>{ window.confirmTarget = card; openConfirm(); });
    if(paintBtn) bindPaintButton(card);

    bindAvatar(card);

    const coreRows = card.querySelectorAll('.counter[data-core="1"]');
    coreRows.forEach(row=>{
      const btns = row.querySelectorAll('button.pm');
      if(btns.length===2){
        const [minus, plus] = [btns[0], btns[1]];
        const isATP = !!row.querySelector('.atp');
        minus.addEventListener('click', ()=>changeAdjacentInput(minus,-1, isATP?999:2048));
        plus.addEventListener('click',  ()=>changeAdjacentInput(plus, 1, isATP?999:2048));
      }
    });

    const toolbar = card.querySelector('.toolbar');
    if(toolbar){
      
</script>
<script>
(function(){
  // defaults
  window.expansionOn = window.expansionOn ?? true;

  function changeVal(input, delta, max){
    var v = parseInt(input.value); if(isNaN(v)) v = 0;
    input.value = Math.max(0, Math.min(max, v + delta));
  }

  function bindPlayerCard(card){
    if(!card) return;
    // bind +/- for core counters
    card.querySelectorAll('.counter').forEach(function(row){
      var input = row.querySelector('input');
      if(!input) return;
      var btns = row.querySelectorAll('button.pm');
      if(btns[0]) btns[0].addEventListener('click', function(){ changeVal(input, -1, 2048); updateLeaderboard(); });
      if(btns[1]) btns[1].addEventListener('click', function(){ changeVal(input, +1, 2048); updateLeaderboard(); });
    });
  }

  function bindExpansionToggle(){
    var btn = document.getElementById('expansion-toggle');
    if(!btn) return;
    btn.addEventListener('click', function(){
      window.expansionOn = !window.expansionOn;
      btn.textContent = window.expansionOn ? 'ON' : 'OFF';
      btn.classList.toggle('on', window.expansionOn);
      btn.classList.toggle('off', !window.expansionOn);
      document.querySelectorAll('.toolbar .expansion, .toolbar .exp-core').forEach(function(b){
        b.classList.toggle('hidden', !window.expansionOn);
      });
      updateLeaderboard();
    });
  }

  function updateLeaderboard(){
    var board = document.getElementById('leaderboard');
    var container = document.getElementById('players-container');
    if(!board || !container) return;
    var cards = Array.prototype.slice.call(container.querySelectorAll('.player'));
    if(cards.length===0){
      board.innerHTML = '<div class="lb-head"><div class="lb-title"><h3>🏆 Leaderboard</h3></div></div><div>No players</div>';
      return;
    }
    var players = cards.map(function(card,i){
      var name = (card.querySelector('input.player-name')?.value || ('Player '+(i+1))).trim();
      var avatar = (card.querySelector('.avatar')?.textContent || '👤').trim();
      var atp = parseInt(card.querySelector('input.atp')?.value) || 0;
      var glu = parseInt(card.querySelector('input.glu')?.value) || 0;
      var bg = (card.style.background && card.style.background.trim()) || '#ffffff';
      return {name:name, avatar:avatar, atp:atp, glu:glu, bg:bg};
    }).sort(function(a,b){ return (b.atp-a.atp) || (b.glu-a.glu); });

    var champ = players[0];
    function chip(bg){ return 'style="background:'+bg+';"'; }

    board.innerHTML =
      '<div class="lb-head">'+
        '<div class="lb-title"><h3>🏆 Leaderboard</h3></div>'+
        '<div class="toggle-wrap"><span>WTDGAP Expansion Pack</span><button id="expansion-toggle" class="toggle-btn '+(window.expansionOn?'on">ON':'off">OFF')+'</button></div>'+
      '</div>'+
      '<div class="champ-row">'+
        '<div class="champ-left"><span class="chip-btn big" '+chip(champ.bg)+'>'+champ.avatar+' <b class="name-text">'+champ.name+'</b></span></div>'+
        '<div class="champ-right">⚡ '+champ.atp+' &nbsp; | &nbsp; 🍞 '+champ.glu+'</div>'+
      '</div>'+
      '<hr class="lb-divider" />'+
      players.map(function(p,i){
        return '<div class="row">'+
          '<div class="namecell">'+
            '<span class="pill-btn" '+chip(p.bg)+'>'+(i+1)+'</span> '+
            '<span class="chip-btn" '+chip(p.bg)+'>'+p.avatar+' <b class="name-text">'+p.name+'</b></span>'+
          '</div>'+
          '<div class="stats" style="text-align:right;">ATP '+String(p.atp).padStart(3)+' | Glu '+String(p.glu).padStart(3)+'</div>'+
          '<div>🏅</div>'+
        '</div>';
      }).join('');

    bindExpansionToggle();
  }

  function init(){
    // Bind the first existing player (if present)
    var first = document.querySelector('#players-container .player');
    if(first) bindPlayerCard(first);
    updateLeaderboard();
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // expose globally
  window.updateLeaderboard = updateLeaderboard;
  window.bindPlayerCard = bindPlayerCard;
  window.bindExpansionToggle = bindExpansionToggle;
  window.updateAddPlayerButton = updateAddPlayerButton;
  window.reindex = reindex;
})();
</script>


<style>
  .icon-mini.drag-handle{cursor:grab;}
  .icon-mini.drag-handle:active{cursor:grabbing;}
  .player.dragging{opacity:0.92;box-shadow:0 10px 24px rgba(0,0,0,.15);}
</style>
<script>
(function(){
  var container = document.getElementById('players-container');
  if(!container) return;

  var dragging = null, placeholder = null, startY = 0, startTop = 0, startRect = null, originWidth = 0;

  var lockTimer = null; var lockTimeoutMs = 220;
function lockScroll(lock){
  var b = document.body, h = document.documentElement;
  if(lock){ if(b) b.classList.add('scroll-locked'); if(h) h.classList.add('scroll-locked'); }
  else { if(b) b.classList.remove('scroll-locked'); if(h) h.classList.remove('scroll-locked'); }
}
function beginDrag(card, clientY){
    var scrollY = window.scrollY || window.pageYOffset;
    startRect = card.getBoundingClientRect();
    originWidth = card.offsetWidth;
    placeholder = document.createElement('div');
    placeholder.className = 'player placeholder';
    placeholder.style.height = startRect.height + 'px';
    container.insertBefore(placeholder, card.nextSibling);
    card.classList.add('dragging');
    card.style.position = 'absolute';
    card.style.width = originWidth + 'px';
    var scrollX = window.scrollX || window.pageXOffset;
    card.style.left = (startRect.left + scrollX) + 'px';
    lockScroll(true);
    try{ if(lockTimer) clearTimeout(lockTimer); }catch(e){}
    card.style.top  = (startRect.top + scrollY) + 'px';
    card.style.pointerEvents = 'none';
    dragging = card;
    startY = clientY + scrollY;
    startTop = (startRect.top + scrollY);
    document.addEventListener('pointermove', onMove, {passive:false});
    document.addEventListener('pointerup', onUp, {once:true});
    document.addEventListener('pointercancel', onCancel, {once:true});
    lockScroll(true);
    try{ if(lockTimer) clearTimeout(lockTimer); }catch(e){}
    document.addEventListener('visibilitychange', function(){ if(document.hidden){ try{ if(lockTimer){ clearTimeout(lockTimer); lockTimer=null; } lockScroll(false); }catch(e){} } }, {once:true});
  }

  
  function onCancel(e){
    try{
      dragging=null;
      if(placeholder){ placeholder.remove(); placeholder=null; }
      if(lockTimer){ clearTimeout(lockTimer); lockTimer=null; }
      lockScroll(false);
    }finally{
      document.removeEventListener('pointermove', onMove);
      document.removeEventListener('pointerup', onUp);
    }
    try{ if(lockTimer){ clearTimeout(lockTimer); lockTimer=null; } lockScroll(false); }catch(e){}
  }
function onMove(e){
    if(!dragging) return;
    
    try{ if(lockTimer) clearTimeout(lockTimer); lockTimer = setTimeout(function(){ lockScroll(false); }, lockTimeoutMs); }catch(e){}
if(e && e.preventDefault) e.preventDefault();
    var scrollY = window.scrollY || window.pageYOffset;
    var viewportH = window.innerHeight || document.documentElement.clientHeight;
    var edge = 60;
    if(e.clientY < edge){ window.scrollBy(0, -12); scrollY = window.scrollY || window.pageYOffset; }
    else if(e.clientY > viewportH - edge){ window.scrollBy(0, 12); scrollY = window.scrollY || window.pageYOffset; }
    var y = e.clientY + scrollY;
    var dy = y - startY;
    dragging.style.top = (startTop + dy) + 'px';

    var cards = Array.prototype.slice.call(container.querySelectorAll('.player'))
      .filter(function(el){ return el!==dragging && el!==placeholder; });

    for(var i=0;i<cards.length;i++){
      var r = cards[i].getBoundingClientRect();
      var mid = (r.top + scrollY + r.height/2);
      if(y < mid){ container.insertBefore(placeholder, cards[i]); return; }
    }
    container.appendChild(placeholder);
  }

  function onUp(){
    if(dragging){
      container.insertBefore(dragging, placeholder);
      dragging.classList.remove('dragging');
      dragging.style.position='';
      dragging.style.width='';
      dragging.style.left='';
      dragging.style.top='';
      dragging.style.pointerEvents='';
      dragging = null;
      if(placeholder){ placeholder.remove(); placeholder=null; }
      if(typeof window.updateLeaderboard === 'function'){ try{ window.updateLeaderboard(); }catch(e){} }
    }
    document.removeEventListener('pointermove', onMove);
    document.removeEventListener('pointerup', onUp);
  }
    try{ if(lockTimer){ clearTimeout(lockTimer); lockTimer=null; } lockScroll(false); }catch(e){}
    try{ if(lockTimer) { clearTimeout(lockTimer); lockTimer=null; } lockScroll(false); }catch(e){}
    try{ document.body.style.overflow=''; }catch(e){};
    try{ if(typeof window.updateAddPlayerButton==='function') window.updateAddPlayerButton(); }catch(e){}

  // Event delegation: only handle drags when starting from the handle
  container.addEventListener('pointerdown', function(e){
    var handle = e.target.closest('.drag-handle');
    if(!handle) return;
    var card = handle.closest('.player');
    if(!card) return;
    e.preventDefault();
    beginDrag(card, e.clientY);
  });

  // Kill the old long-press-to-reorder without hurting normal buttons.
  // We intercept pointerdown on non-interactive blank areas inside a player (capture phase)
  container.addEventListener('pointerdown', function(e){
    var inPlayer = e.target.closest('.player');
    if(!inPlayer) return;
    var isHandle = !!e.target.closest('.drag-handle');
    var isInteractive = !!e.target.closest('button, [role="button"], input, select, textarea, a, label, .pm, .remove-btn, .icon-mini, .chip-btn, .pill-btn, .toggle-wrap, .toolbar, .value-input, .avatar');
    if(!isHandle && !isInteractive){
      // Block legacy long-press listeners attached higher up
      e.stopImmediatePropagation();
    }
  }, true);
})();

// Global failsafe: always unlock scroll on any pointer/touch end or click
(function(){
  function unlockSafely(){
    try{ lockScroll(false); }catch(e){}
  }
  window.addEventListener('pointerup', unlockSafely, {passive:true});
  window.addEventListener('touchend', unlockSafely, {passive:true});
  window.addEventListener('click', unlockSafely, {passive:true});
  window.addEventListener('keyup', function(e){ if(e.key==='Escape') unlockSafely(); }, {passive:true});
})();
</script>


<script>
(function(){
  // Wire confirm modal for deleting a player card
  var mask = document.getElementById('confirm-mask');
  var btnYes = document.getElementById('confirm-yes');
  var btnNo  = document.getElementById('confirm-no');
  function openConfirm(){
    if(!mask) return;
    mask.style.display = 'flex';
  }
  function closeConfirm(){
    if(!mask) return;
    mask.style.display = 'none';
  }
  window.openConfirm = openConfirm;
  // Clicks
  if(btnNo){
    btnNo.addEventListener('click', function(e){ e.preventDefault(); closeConfirm(); window.confirmTarget = null; });
  }
  if(btnYes){
    btnYes.addEventListener('click', function(e){
      e.preventDefault();
      try{
        var card = window.confirmTarget && window.confirmTarget.closest ? window.confirmTarget : null;
        if(card && card.parentNode){
          card.parentNode.removeChild(card);
          
          try{ if(typeof window.reindex==='function') window.reindex(); }catch(x){}
          (function(){ var btn=document.getElementById('add-player-btn'); if(btn){ btn.disabled=false; btn.removeAttribute('disabled'); btn.setAttribute('aria-disabled','false'); btn.textContent='➕ Add Player'; } })();
          try{ if(typeof window.updateAddPlayerButton==='function') { window.updateAddPlayerButton(); setTimeout(window.updateAddPlayerButton,0); setTimeout(window.updateAddPlayerButton,60);} }catch(x){}
          try{ if(typeof window.updateLeaderboard==='function') window.updateLeaderboard(); }catch(x){}
    
        }
      }finally{
        window.confirmTarget = null;
        closeConfirm();
      }
    });
  }

  // Default Expansion OFF on page load
  try{
    window.expansionOn = false;
    if(typeof window.bindExpansionToggle === 'function'){
      // re-render leaderboard so the toggle shows OFF
      if(typeof window.updateLeaderboard === 'function'){ window.updateLeaderboard(); }
    }
  }catch(e){}

  // Ensure modal can be dismissed by clicking backdrop
  if(mask){
    mask.addEventListener('click', function(e){ if(e.target === mask) closeConfirm(); });
  }
})();
</script>


<script>
// Auto-sync Add Player button state with DOM mutations
(function(){
  var container = document.getElementById('players-container');
  if(!container || !('MutationObserver' in window)) return;
  var mo = new MutationObserver(function(){
    try{ updateAddPlayerButton(); }catch(e){}
  });
  mo.observe(container, { childList: true, subtree: true });
})();
</script>


<!-- Mobile Drag Fix v3: handle-only, scroll-safe, with full cleanup -->
<style>
  /* Ensure handle and dragging element do not hand off gestures to browser */
  .icon-mini.drag-handle{ touch-action: none !important; cursor: grab; }
  .icon-mini.drag-handle:active{ cursor: grabbing; }
  .player.dragging{ touch-action: none !important; }
  html.scroll-locked, body.scroll-locked { overflow: hidden !important; overscroll-behavior: contain; touch-action: none !important; }
</style>
<script>
(function(){
  if (window.__DragFixV3Applied__) return;
  window.__DragFixV3Applied__ = true;

  function lockScroll(lock){
    try{
      document.documentElement.classList.toggle('scroll-locked', lock);
      document.body.classList.toggle('scroll-locked', lock);
    }catch(e){}
  }
  function unlockScroll(){ lockScroll(false); }

  // Always unlock scroll on critical lifecycle events
  ['pointerup','touchend','touchcancel','blur','pageshow'].forEach(function(ev){
    window.addEventListener(ev, unlockScroll, {passive:true});
  });
  document.addEventListener('visibilitychange', function(){ if(document.hidden) unlockScroll(); });

  var container = document.getElementById('players-container');
  if(!container) return;

  // Disable legacy long-press reorder by swallowing its pointerdown on non-handle areas
  container.addEventListener('pointerdown', function(e){
    var isHandle = !!e.target.closest('.drag-handle');
    if(!isHandle){
      // Stop any previously attached long-press handlers
      e.stopImmediatePropagation();
    }
  }, true);

  // Robust handle-only drag
  var dragging=null, placeholder=null, startY=0, startTop=0, startRect=null, pointerId=null;

  function startDrag(card, e){
    pointerId = e.pointerId;
    var scrollY = window.scrollY || document.documentElement.scrollTop || 0;
    var scrollX = window.scrollX || document.documentElement.scrollLeft || 0;
    startRect = card.getBoundingClientRect();

    // placeholder
    placeholder = document.createElement('div');
    placeholder.className = 'player placeholder';
    placeholder.style.height = startRect.height + 'px';
    card.parentElement.insertBefore(placeholder, card.nextSibling);

    // elevate card
    card.classList.add('dragging');
    var w = card.offsetWidth;
    Object.assign(card.style, {
      position:'absolute', width: w + 'px',
      left: (startRect.left + scrollX) + 'px',
      top:  (startRect.top  + scrollY) + 'px',
      pointerEvents: 'auto'
    });

    try{ e.target.setPointerCapture && e.target.setPointerCapture(pointerId);}catch(_){}
    dragging = card;
    startY    = e.clientY + scrollY;
    startTop  = startRect.top + scrollY;

    lockScroll(true);
    document.addEventListener('pointermove', onMove, {passive:false});
    document.addEventListener('pointerup', onUp, {once:true});
    document.addEventListener('pointercancel', onUp, {once:true});
  }

  function onMove(e){
    if(!dragging) return;
    if(pointerId!=null && e.pointerId!==pointerId) return;
    e.preventDefault(); // stop page scroll

    // Edge auto-scroll
    var vh = window.innerHeight || document.documentElement.clientHeight;
    var edge = 56;
    if(e.clientY < edge) window.scrollBy(0, -14);
    else if(e.clientY > vh - edge) window.scrollBy(0, 14);

    var y  = e.clientY + (window.scrollY || document.documentElement.scrollTop || 0);
    dragging.style.top = (startTop + (y - startY)) + 'px';

    // Reorder
    var parent = placeholder.parentElement;
    var cards = Array.prototype.slice.call(parent.querySelectorAll('.player')).filter(function(el){ return el!==dragging && el!==placeholder; });
    for(var i=0;i<cards.length;i++){
      var r = cards[i].getBoundingClientRect();
      var mid = r.top + (window.scrollY || document.documentElement.scrollTop || 0) + r.height/2;
      if(y < mid){ parent.insertBefore(placeholder, cards[i]); return; }
    }
    parent.appendChild(placeholder);
  }

  function onUp(){
    try{
      if(dragging){
        var parent = placeholder && placeholder.parentElement;
        if(parent) parent.insertBefore(dragging, placeholder);
        dragging.classList.remove('dragging');
        ['position','width','left','top','pointerEvents'].forEach(function(k){ dragging.style[k]=''; });
      }
      if(placeholder) placeholder.remove();
    }finally{
      dragging=null; placeholder=null; pointerId=null;
      document.removeEventListener('pointermove', onMove);
      unlockScroll();
      try{ if(typeof window.updateLeaderboard==='function') window.updateLeaderboard(); }catch(e){}
    }
  }

  container.addEventListener('pointerdown', function(e){
    var handle = e.target.closest('.drag-handle');
    if(!handle) return;
    var card = handle.closest('.player');
    if(!card) return;
    e.preventDefault();
    startDrag(card, e);
  });
})();
</script>

</body>
<script>
(function(){
  function rnd(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function randomPastel(){ var h=rnd(0,360), s=rnd(45,65), l=rnd(88,95); return "hsl("+h+" "+s+"% "+l+"%)"; }
  function qs(id){ return document.getElementById(id); }
  if (typeof window.isDay === "undefined") window.isDay = true;
  if (typeof window.expansionOn === "undefined") window.expansionOn = true;
  function bindCardExtras(card){
    if(!card) return;
    var avatarEl = card.querySelector('.avatar');
    var avatars = ['👤','🐱','🐶','🐼','🦊','🐻','🦆','🐯','🐵','🐰','🐮','🐨','🧙','⚔️','🛡️'];
    if(avatarEl){
      avatarEl.addEventListener('click', function(){
        var curr = avatarEl.textContent.trim();
        var i = Math.max(0, avatars.indexOf(curr));
        avatarEl.textContent = avatars[(i+1)%avatars.length];
        window.updateLeaderboard && window.updateLeaderboard();
      });
    }
    var paintBtn = card.querySelector('.paint-btn');
    if(paintBtn){
      var pressTimer=null, longPressed=false;
      function clearTimer(){ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null;} }
      function start(){ longPressed=false; pressTimer=setTimeout(function(){ longPressed=true; card.style.background='#ffffff'; },600); }
      function end(){ if(!longPressed){ card.style.background = randomPastel(); } clearTimer(); window.updateLeaderboard && window.updateLeaderboard(); }
      paintBtn.addEventListener('mousedown', start);
      paintBtn.addEventListener('mouseup', end);
      paintBtn.addEventListener('mouseleave', clearTimer);
      paintBtn.addEventListener('touchstart', start, {passive:true});
      paintBtn.addEventListener('touchend', end);
      paintBtn.addEventListener('touchcancel', clearTimer);
    }
    card.querySelectorAll('.counter').forEach(function(row){
      var minus = row.querySelector('.pm:nth-of-type(1)');
      var plus  = row.querySelector('.pm:nth-of-type(2)');
      var input = row.querySelector('input.value-input') || row.querySelector('input');
      if(minus && input) minus.addEventListener('click', function(){ var v=parseInt(input.value)||0; input.value=Math.max(0,v-1); window.updateLeaderboard && window.updateLeaderboard(); });
      if(plus && input) plus.addEventListener('click', function(){ var v=parseInt(input.value)||0; input.value=Math.min(2048,v+1); window.updateLeaderboard && window.updateLeaderboard(); });
    });
    var del = card.querySelector('.reorder .icon-mini[title="Delete player"]');
    if(del){
      del.addEventListener('click', function(){ window.confirmTarget = card; if(typeof window.openConfirm==='function'){ window.openConfirm(); } else { /* fallback */ if(confirm('Delete this player?')){ card.parentElement && card.parentElement.removeChild(card); } } });
    }
  }
  function createEmptyCard(){
    var d = document.createElement('div');
    d.className = 'player';
    d.innerHTML = ''
      + '<div class="player-header">'
      +   '<div class="player-title">'
      +     '<h2 class="avatar" title="Click to change avatar">👤</h2>'
      +     '<input class="player-name" value="Player " />'
      +   '</div>'
      +   '<div class="reorder"><button class="icon-mini drag-handle" title="按住上下拖动排序">↕️</button>'
      +     '<button class="icon-mini paint-btn" title="Click: random color • Long press: reset to white">🎨</button>'
      +     '<button class="icon-mini" title="Delete player">🗑️</button>'
      +   '</div>'
      + '</div>'
      + '<div class="counter" data-core="1">'
      +   '<span class="label">⚡ ATP</span>'
      +   '<button class="pm">−</button>'
      +   '<input class="value-input atp" max="999" min="0" type="number" value="20">'
      +   '<button class="pm">+</button>'
      + '</div>'
      + '<div class="counter" data-core="1">'
      +   '<span class="label">🍞 Glucose</span>'
      +   '<button class="pm">−</button>'
      +   '<input class="value-input glu" max="999" min="0" type="number" value="0">'
      +   '<button class="pm">+</button>'
      + '</div>'
      + '<div class="toolbar"></div>'
      + '<div class="section" data-type="mito"></div>'
      + '<div class="section" data-type="cell"></div>'
      + '<div class="section" data-type="infectA"></div>'
      + '<div class="section" data-type="infectB"></div>'
      + '<div class="section" data-type="immune"></div>'
      + '<div class="section" data-type="overcast"></div>'
      + '<div class="section" data-type="dry"></div>'
      + '<div class="section" data-type="ice"></div>'
      + '<div class="section" data-type="para"></div>'
      + '<div class="section" data-type="coop"></div>';
    return d;
  }
  function reindex(){
    var container = qs('players-container');
    if(!container) return;
    Array.prototype.slice.call(container.querySelectorAll('.player')).forEach(function(c,i){
      c.setAttribute('data-player', String(i+1));
      var name = c.querySelector('input.player-name');
      if(name && /^Player\s*\d*$/.test((name.value||'').trim())) name.value = 'Player ' + (i+1);
    });
    updateAddPlayerButton();
  }
  function getRealPlayerCount(){
  var container = qs('players-container');
  if(!container) return 0;
  return container.querySelectorAll('.player:not(.placeholder)').length;
}

function updateAddPlayerButton(){
  var container = qs('players-container'), btn = qs('add-player-btn');
  if(!container || !btn) return;
  var count = getRealPlayerCount();
  var shouldDisable = count >= 6;
  btn.disabled = shouldDisable;
  if(shouldDisable){
    btn.setAttribute('disabled','disabled');
    btn.setAttribute('aria-disabled','true');
    try{ btn.textContent = 'Player cap reached (6)'; }catch(e){}
  }else{
    btn.removeAttribute('disabled');
    btn.setAttribute('aria-disabled','false');
    try{ btn.textContent = '➕ Add Player'; }catch(e){}
  }
}
  function addPlayer(){
  var container = qs('players-container');
  if(!container) return;
  var count = getRealPlayerCount();
  if(count >= 6){ updateAddPlayerButton(); return; }
    var card = createEmptyCard();
    container.appendChild(card);
    bindCardExtras(card);
    reindex();
    window.updateLeaderboard && window.updateLeaderboard();
  }
  function resetGame(){
    var turn = qs('turn'); if(turn) turn.value = 1;
    var day = qs('daynight'); if(day) day.textContent = '🌞 Day';
    window.isDay = true;
    var container = qs('players-container');
    if(container){
      Array.prototype.slice.call(container.querySelectorAll('.player')).forEach(function(card,i){
        var atp = card.querySelector('input.atp'); if(atp) atp.value = 20;
        var glu = card.querySelector('input.glu'); if(glu) glu.value = 0;
        card.querySelectorAll('.section').forEach(function(sec){ sec.innerHTML=''; });
        var name = card.querySelector('input.player-name');
        if(name && /^Player\s*\d*$/.test((name.value||'').trim())) name.value = 'Player ' + (i+1);
      });
    }
    reindex();
    window.updateLeaderboard && window.updateLeaderboard();
  }
  function nextWrapper(){
    if (typeof window.nextTurn === "function"){
      window.nextTurn();
    } else {
      var turn = qs('turn'); if(turn) turn.value = (parseInt(turn.value)||1) + 1;
      var day = qs('daynight');
      if(day) day.textContent = window.isDay ? '🌙 Night' : '🌞 Day';
      window.isDay = !window.isDay;
    }
    var audio = qs('click-sound'); if(audio){ try{ audio.currentTime=0; audio.play(); }catch(e){} }
    window.updateLeaderboard && window.updateLeaderboard();
  }
  function switchWrapper(){
    window.isDay = !window.isDay;
    var day = qs('daynight'); if(day) day.textContent = window.isDay ? '🌞 Day' : '🌙 Night';
  }
  function wireControls(){
    var addBtn = qs('add-player-btn'); if(addBtn){ addBtn.addEventListener('click', addPlayer); }
    var resetBtn = qs('reset-btn'); if(resetBtn){ resetBtn.addEventListener('click', resetGame); }
    var switchBtn = qs('switch-btn'); if(switchBtn){ switchBtn.addEventListener('click', switchWrapper); }
    var nextBtn = qs('next-btn'); if(nextBtn){ nextBtn.addEventListener('click', nextWrapper); }
  }
  function initWiring(){
    var first = document.querySelector('#players-container .player');
    bindCardExtras(first);
    wireControls();
    reindex();
    updateAddPlayerButton();
    if (typeof window.updateLeaderboard === "function"){ window.updateLeaderboard(); }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initWiring);
  } else {
    initWiring();
  }
  window.addPlayer = addPlayer;
  window.resetGame = resetGame;
})();
</script><script>
(function(){
  // === Toolbar builder ===
  function buildToolbar(card){
    var toolbar = card.querySelector('.toolbar');
    if(!toolbar) return;
    toolbar.innerHTML = "";
    function makeBtn(label, emoji, sectionType, def, extraClass){
      var b = document.createElement('button');
      b.className = 'icon-btn ' + (extraClass||"");
      b.textContent = emoji;
      b.title = label;
      b.setAttribute('aria-label', 'Add ' + label);
      b.addEventListener('click', function(){
        var sec = card.querySelector('.section[data-type="'+sectionType+'"]');
        if(!sec) return;
        var existing = sec.querySelectorAll('.counter').length;
        if(existing >= 3) return;
        var div = document.createElement('div');
        div.className = 'counter';
        div.innerHTML = '<span class="label">'+ (sectionType==='coop' ? '🤝 Cooperation' : (emoji+' '+label)) + '</span>'
          + '<button class="pm minus">−</button>'
          + '<input type="number" min="0" max="2048" value="'+def+'" class="value-input" inputmode="numeric" pattern="[0-9]*">'
          + '<button class="pm plus">+</button>'
          + '<button class="remove-btn" title="Delete">❌</button>';
        sec.appendChild(div);
        var minus = div.querySelector('button.minus');
        var plus  = div.querySelector('button.plus');
        var input = div.querySelector('input.value-input');
        var del   = div.querySelector('button.remove-btn');
        if(minus) minus.addEventListener('click', function(){ var v=parseInt(input.value)||0; input.value=Math.max(0,v-1); window.updateLeaderboard && window.updateLeaderboard(); });
        if(plus)  plus.addEventListener('click', function(){ var v=parseInt(input.value)||0; input.value=Math.min(2048,v+1); window.updateLeaderboard && window.updateLeaderboard(); });
        if(del)   del.addEventListener('click', function(){ div.remove(); window.updateLeaderboard && window.updateLeaderboard(); });
      });
      return b;
    }
    [
      ['Mitosis','🧬','mito',5,''],
      ['Cell','🔬','cell',1,''],
      ['Acute','🦠','infectA',3,'exp-core'],
      ['Chronic','☣︎','infectB',5,'exp-core'],
      ['Immune','🛡️','immune',2,'exp-core'],
      ['Overcast','☁️','overcast',2,'expansion'],
      ['DrySeason','🔥','dry',2,'expansion'],
      ['IceAge','🧊','ice',4,'expansion'],
      ['Parasitism','👾','para',1,'expansion'],
      ['Cooperation','🤝','coop',2,'expansion'],
    ].forEach(function(args){ toolbar.appendChild(makeBtn.apply(null,args)); });

    // Respect expansionOn visibility
    var visible = (typeof window.expansionOn === 'undefined') ? true : window.expansionOn;
    toolbar.querySelectorAll('.expansion, .exp-core').forEach(function(b){
      b.classList.toggle('hidden', !visible);
    });
  }

  // Hook into existing helpers if present
  window.buildToolbar = window.buildToolbar || buildToolbar;

  // Enhance our previous createEmptyCard if it exists, else replace local reference
  var _createEmptyCard = (typeof window.createEmptyCard === 'function') ? window.createEmptyCard : null;

  function createEmptyCardWithToolbar(){
    var card = _createEmptyCard ? _createEmptyCard() : (function(){
      var d = document.createElement('div');
      d.className = 'player';
      d.innerHTML = ''
        + '<div class="player-header">'
        +   '<div class="player-title">'
        +     '<h2 class="avatar" title="Click to change avatar">👤</h2>'
        +     '<input class="player-name" value="Player " />'
        +   '</div>'
        +   '<div class="reorder"><button class="icon-mini drag-handle" title="按住上下拖动排序">↕️</button>'
        +     '<button class="icon-mini paint-btn" title="Click: random color • Long press: reset to white">🎨</button>'
        +     '<button class="icon-mini" title="Delete player">🗑️</button>'
        +   '</div>'
        + '</div>'
        + '<div class="counter" data-core="1">'
        +   '<span class="label">⚡ ATP</span>'
        +   '<button class="pm">−</button>'
        +   '<input class="value-input atp" max="999" min="0" type="number" value="20">'
        +   '<button class="pm">+</button>'
        + '</div>'
        + '<div class="counter" data-core="1">'
        +   '<span class="label">🍞 Glucose</span>'
        +   '<button class="pm">−</button>'
        +   '<input class="value-input glu" max="999" min="0" type="number" value="0">'
        +   '<button class="pm">+</button>'
        + '</div>'
        + '<div class="toolbar"></div>'
        + '<div class="section" data-type="mito"></div>'
        + '<div class="section" data-type="cell"></div>'
        + '<div class="section" data-type="infectA"></div>'
        + '<div class="section" data-type="infectB"></div>'
        + '<div class="section" data-type="immune"></div>'
        + '<div class="section" data-type="overcast"></div>'
        + '<div class="section" data-type="dry"></div>'
        + '<div class="section" data-type="ice"></div>'
        + '<div class="section" data-type="para"></div>'
        + '<div class="section" data-type="coop"></div>';
      return d;
    })();
    // ensure toolbar exists
    buildToolbar(card);
    // also re-bind extras from earlier patch if available
    if (typeof window.bindCardExtras === 'function') window.bindCardExtras(card);
    return card;
  }
  window.createEmptyCard = createEmptyCardWithToolbar;

  // === Long-press drag reorder ===
  
function enableLongPressDrag(container){
  if(!container) return;
  let dragging=null, placeholder=null;
  let startClientY=0, startY=0, startTop=0, startRect=null, pointerId=null, longPressTimer=null;
  const holdMs=300, moveThreshold=12;

  function lockScroll(lock){
    try{
      document.documentElement.classList.toggle('scroll-locked', lock);
      document.body.classList.toggle('scroll-locked', lock);
    }catch(e){}
  }

  function startDrag(card, downEvent){
    pointerId = downEvent.pointerId;
    const scrollY = window.scrollY || document.documentElement.scrollTop || 0;
    const scrollX = window.scrollX || document.documentElement.scrollLeft || 0;
    startRect = card.getBoundingClientRect();

    placeholder = document.createElement('div');
    placeholder.className = 'player placeholder';
    placeholder.style.height = startRect.height + 'px';
    card.parentElement.insertBefore(placeholder, card.nextSibling);

    card.classList.add('dragging');
    const originW = card.offsetWidth;
    Object.assign(card.style, {
      position:'absolute',
      width: originW + 'px',
      left: (startRect.left + scrollX) + 'px',
      top:  (startRect.top  + scrollY) + 'px',
      pointerEvents:'auto',
      touchAction:'none'
    });
    dragging = card;

    try{ card.setPointerCapture && card.setPointerCapture(pointerId);}catch(_){}
    startClientY = downEvent.clientY;
    startY = startClientY + scrollY;
    startTop = startRect.top + scrollY;

    lockScroll(true);
    document.addEventListener('pointermove', onMove, {passive:false});
    window.addEventListener('pointerup', onUp, {once:true});
    window.addEventListener('pointercancel', onUp, {once:true});
    window.addEventListener('blur', onUp, {once:true});
    document.addEventListener('visibilitychange', onVis, {once:true});
    try{ navigator.vibrate && navigator.vibrate(30);}catch(e){}
  }

  function onMove(e){
    if(!dragging) return;
    if(pointerId!=null && e.pointerId!==pointerId) return;
    e.preventDefault();

    const vh = window.innerHeight || document.documentElement.clientHeight;
    const edge = 60;
    if(e.clientY < edge) window.scrollBy(0, -14);
    else if(e.clientY > vh - edge) window.scrollBy(0, 14);

    const y  = e.clientY + (window.scrollY || document.documentElement.scrollTop || 0);
    const dy = y - startY;
    dragging.style.top = (startTop + dy) + 'px';

    const container = placeholder.parentElement;
    const cards = Array.from(container.querySelectorAll('.player')).filter(el => el!==dragging && el!==placeholder);
    for(const el of cards){
      const r = el.getBoundingClientRect();
      const center = r.top + (window.scrollY||document.documentElement.scrollTop||0) + r.height/2;
      if(y < center){ container.insertBefore(placeholder, el); return; }
    }
    container.appendChild(placeholder);
  }

  function onUp(){
    if(dragging){
      const container = placeholder.parentElement;
      container.insertBefore(dragging, placeholder);
      dragging.classList.remove('dragging');
      ['position','width','left','top','pointerEvents','touchAction','maxWidth'].forEach(k=> dragging.style[k]='');
      dragging=null;
    }
    placeholder && placeholder.remove();
    placeholder=null;
    pointerId=null;

    document.removeEventListener('pointermove', onMove);
    lockScroll(false);
    if (typeof window.updateLeaderboard==='function') window.updateLeaderboard();
  }

  function onVis(){ onUp(); }

  function onDown(e){
    const card = e.target.closest('.player');
    if(!card || !container.contains(card)) return;
    if(e.target.closest('button, input, select, textarea, a, .icon-btn, .pm, .paint-btn, .toolbar, .reorder, .value-input')) return;

    pointerId = e.pointerId;
    startClientY = e.clientY;
    const downScrollY = window.scrollY || document.documentElement.scrollTop || 0;

    clearTimeout(longPressTimer);
    longPressTimer = setTimeout(()=>{
      const moved = Math.abs((window.scrollY||document.documentElement.scrollTop||0) - downScrollY) > moveThreshold;
      if(!moved) startDrag(card, e);
    }, holdMs);

    function cancelMove(ev){
      const dy = Math.abs(ev.clientY - startClientY);
      const sy = Math.abs((window.scrollY||document.documentElement.scrollTop||0) - downScrollY);
      if(dy > moveThreshold || sy > moveThreshold){
        clearTimeout(longPressTimer);
        container.removeEventListener('pointermove', cancelMove);
        container.removeEventListener('pointerup', cancelHold);
      }
    }
    function cancelHold(){
      clearTimeout(longPressTimer);
      container.removeEventListener('pointermove', cancelMove);
      container.removeEventListener('pointerup', cancelHold);
    }
    container.addEventListener('pointermove', cancelMove, {passive:true});
    container.addEventListener('pointerup', cancelHold, {once:true});
  }

  container.addEventListener('pointerdown', onDown);
  container.style.touchAction = 'manipulation';
}

  window.enableLongPressDrag = window.enableLongPressDrag || enableLongPressDrag;

  // === Auto-init for existing cards and container ===
  function initToolbarAndDrag(){
    document.querySelectorAll('#players-container .player').forEach(function(card){
      try{ buildToolbar(card); }catch(e){}
    });
    var container = document.getElementById('players-container');
    enableLongPressDrag(container);
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initToolbarAndDrag);
  } else {
    initToolbarAndDrag();
  }
})();
</script><script>
(function(){
  if (typeof window.addPlayer === 'function'){
    var _origAdd = window.addPlayer;
    window.addPlayer = function(){
      var container = document.getElementById('players-container');
      _origAdd();
      try{
        if(container){
          var cards = container.querySelectorAll('.player');
          var card = cards[cards.length-1];
          if(card){
            if (typeof window.buildToolbar === 'function') window.buildToolbar(card);
            if (typeof window.bindCardExtras === 'function') window.bindCardExtras(card);
          }
        }
      }catch(e){ console.error(e); }
      if (typeof window.updateLeaderboard === 'function') window.updateLeaderboard();
    };
  }
})();
</script><script>
(function(){
  function safelyBuildAll(){
    try {
      document.querySelectorAll('#players-container .player').forEach(function(card){
        if (typeof window.buildToolbar === 'function') window.buildToolbar(card);
      });
    } catch(e){ console.error(e); }
  }
  // run at load for existing
  if (document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', safelyBuildAll);
  } else {
    safelyBuildAll();
  }
  // wrap addPlayer
  if (typeof window.addPlayer === 'function'){
    var _orig = window.addPlayer;
    window.addPlayer = function(){
      var container = document.getElementById('players-container');
      _orig();
      try{
        var cards = container ? container.querySelectorAll('.player') : [];
        var card = cards.length ? cards[cards.length-1] : null;
        if(card && typeof window.buildToolbar === 'function') window.buildToolbar(card);
      }catch(e){ console.error(e); }
    };
  }
})();
</script>
<script>
(function(){
  // Ensure buildToolbar exists (fallback no-op to avoid errors)
  if (typeof window.buildToolbar !== 'function') {
    window.buildToolbar = function(card){
      var toolbar = card && card.querySelector('.toolbar');
      if (!toolbar) return;
      toolbar.innerHTML = "";
      function makeBtn(label, emoji, sectionType, def, extraClass){
        var b = document.createElement('button');
        b.className = 'icon-btn ' + (extraClass||"");
        b.textContent = emoji;
        b.title = label;
        b.setAttribute('aria-label', 'Add ' + label);
        b.addEventListener('click', function(){
          var sec = card.querySelector('.section[data-type="'+sectionType+'"]');
          if(!sec) return;
          var existing = sec.querySelectorAll('.counter').length;
          if(existing >= 3) return;
          var div = document.createElement('div');
          div.className = 'counter';
          div.innerHTML = '<span class="label>'+ (sectionType==='coop' ? '">🤝 Cooperation' : '">'+emoji+' '+label) + '</span>'
            + '<button class="pm minus">−</button>'
            + '<input type="number" min="0" max="2048" value="'+def+'" class="value-input" inputmode="numeric" pattern="[0-9]*">'
            + '<button class="pm plus">+</button>'
            + '<button class="remove-btn" title="Delete">❌</button>';
          sec.appendChild(div);
          var minus = div.querySelector('button.minus');
          var plus  = div.querySelector('button.plus');
          var input = div.querySelector('input.value-input');
          var del   = div.querySelector('button.remove-btn');
          if(minus) minus.addEventListener('click', function(){ var v=parseInt(input.value)||0; input.value=Math.max(0,v-1); window.updateLeaderboard && window.updateLeaderboard(); });
          if(plus)  plus.addEventListener('click', function(){ var v=parseInt(input.value)||0; input.value=Math.min(2048,v+1); window.updateLeaderboard && window.updateLeaderboard(); });
          if(del)   del.addEventListener('click', function(){ div.remove(); window.updateLeaderboard && window.updateLeaderboard(); });
        });
        return b;
      }
      [
        ['Mitosis','🧬','mito',5,''],
        ['Cell','🔬','cell',1,''],
        ['Acute','🦠','infectA',3,'exp-core'],
        ['Chronic','☣︎','infectB',5,'exp-core'],
        ['Immune','🛡️','immune',2,'exp-core'],
        ['Overcast','☁️','overcast',2,'expansion'],
        ['DrySeason','🔥','dry',2,'expansion'],
        ['IceAge','🧊','ice',4,'expansion'],
        ['Parasitism','👾','para',1,'expansion'],
        ['Cooperation','🤝','coop',2,'expansion'],
      ].forEach(function(args){ toolbar.appendChild(makeBtn.apply(null,args)); });

      // Respect expansion toggle
      var visible = (typeof window.expansionOn === 'undefined') ? true : window.expansionOn;
      toolbar.querySelectorAll('.expansion, .exp-core').forEach(function(b){
        b.classList.toggle('hidden', !visible);
      });
    };
  }

  function ensureToolbar(card){
    if(!card) return;
    var toolbar = card.querySelector('.toolbar');
    if(!toolbar) return;
    // If toolbar is empty or missing our first emoji, rebuild
    if (!toolbar.querySelector('.icon-btn') || toolbar.textContent.indexOf('🧬') === -1) {
      try { window.buildToolbar(card); } catch(e) { console.error(e); }
    }
    // Also (re)bind extras if provided by earlier patches
    if (typeof window.bindCardExtras === 'function') {
      try { window.bindCardExtras(card); } catch(e){ console.error(e); }
    }
  }

  function scanAll(){
    document.querySelectorAll('#players-container .player').forEach(ensureToolbar);
  }

  // Run once at load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', scanAll);
  } else {
    scanAll();
  }

  // Observe future additions
  var cont = document.getElementById('players-container');
  if (cont && typeof MutationObserver !== 'undefined') {
    var mo = new MutationObserver(function(muts){
      muts.forEach(function(m){
        m.addedNodes && m.addedNodes.forEach(function(n){
          if (n.nodeType === 1 && n.classList && n.classList.contains('player')) {
            ensureToolbar(n);
          } else if (n.nodeType === 1) {
            // if a wrapper was inserted, scan inside
            var cards = n.querySelectorAll ? n.querySelectorAll('.player') : [];
            cards && cards.forEach(ensureToolbar);
          }
        });
      });
    });
    mo.observe(cont, {childList: true, subtree: true});
  }

  // Also hook the Add Player button to rebuild after click (double safety)
  var addBtn = document.getElementById('add-player-btn');
  if (addBtn) {
    addBtn.addEventListener('click', function(){
      setTimeout(scanAll, 0);
      setTimeout(scanAll, 60);
    });
  }
})();
</script>
</html>
